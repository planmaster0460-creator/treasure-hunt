<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ìŠ¤íƒ¬í”„ íˆ¬ì–´</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body, #root { width: 100%; min-height: 100vh; min-height: 100dvh; }
  body { font-family: 'Noto Sans KR', sans-serif; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
</style>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
<script>
window.storage = {
  async get(key, shared) {
    const v = localStorage.getItem("st_" + key);
    if (v === null) throw new Error("Key not found");
    return { key, value: v, shared: !!shared };
  },
  async set(key, value, shared) {
    localStorage.setItem("st_" + key, value);
    return { key, value, shared: !!shared };
  },
  async delete(key, shared) {
    localStorage.removeItem("st_" + key);
    return { key, deleted: true, shared: !!shared };
  },
  async list(prefix, shared) {
    const keys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k.startsWith("st_" + (prefix || ""))) keys.push(k.slice(3));
    }
    return { keys, prefix, shared: !!shared };
  }
};
</script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const { useState, useEffect, useRef, useCallback } = React;


/* â”€â”€â”€ DEFAULT CONFIG â”€â”€â”€ */
const DEFAULT_CONFIG = {
  festivalName: "2026 ëŒ€ì „ ì‚¬ì´ì–¸ìŠ¤ í˜ìŠ¤í‹°ë²Œ",
  subtitle: "ëª¨ë°”ì¼ AI ìŠ¤íƒ¬í”„ íˆ¬ì–´",
  primaryColor: "#0A2463",
  secondaryColor: "#00B4D8",
  accentColor: "#FB8500",
  bgColor: "#F0F7FF",
  textColor: "#1B1B2F",
  cardBg: "#FFFFFF",
  fontFamily: "'Noto Sans KR', sans-serif",
  titleFont: "'Black Han Sans', sans-serif",
  bgTheme: "space",
  completionMessage: "ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰\nëª¨ë“  ìŠ¤íƒ¬í”„ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤!\n\nğŸ“ DCC 2ì „ì‹œì¥ ì¢…í•©ì•ˆë‚´ì†Œì—ì„œ\nê¸°ë…í’ˆì„ ìˆ˜ë ¹í•˜ì„¸ìš”!\n\nâ€» ê¸°ë…í’ˆ ì†Œì§„ ì‹œ ì´ë²¤íŠ¸ê°€ ì¡°ê¸° ì¢…ë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
  festivalInfo: "2026 ëŒ€ì „ ì‚¬ì´ì–¸ìŠ¤ í˜ìŠ¤í‹°ë²Œì€ ëŒ€ì „ê´‘ì—­ì‹œ ì—‘ìŠ¤í¬ì‹œë¯¼ê´‘ì¥ ì¼ëŒ€ì—ì„œ ê°œìµœë©ë‹ˆë‹¤.\n\nâ–¶ ê¸°ê°„: 2026ë…„ 10ì›” 15ì¼ ~ 10ì›” 20ì¼\nâ–¶ ì¥ì†Œ: ëŒ€ì „ ì—‘ìŠ¤í¬ì‹œë¯¼ê´‘ì¥ ë° ê³¼í•™ë¬¸í™”ê±°ë¦¬\nâ–¶ ì£¼ìµœ: ëŒ€ì „ê´‘ì—­ì‹œ\nâ–¶ ì£¼ê´€: ëŒ€ì „ê´€ê´‘ê³µì‚¬\n\në‹¤ì–‘í•œ ê³¼í•™ ì²´í—˜ í”„ë¡œê·¸ë¨ê³¼ ê³µì—°, ì „ì‹œê°€ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.",
  apiKey: "",
  faqList: [
    { keywords: "ì£¼ì°¨,ì£¼ì°¨ì¥,íŒŒí‚¹,ì°¨", answer: "DCC ì§€í•˜ì£¼ì°¨ì¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”. í–‰ì‚¬ ê¸°ê°„ ì¤‘ ë¬´ë£Œ ì£¼ì°¨ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤." },
    { keywords: "ì‹œê°„,ëª‡ì‹œ,ìš´ì˜,ì–¸ì œ,ì˜¤í”ˆ", answer: "ìš´ì˜ì‹œê°„ì€ 10:00 ~ 18:00 ì…ë‹ˆë‹¤. (ì…ì¥ë§ˆê° 17:30)" },
    { keywords: "ìŠ¤íƒ¬í”„,íˆ¬ì–´,ë°©ë²•,ì–´ë–»ê²Œ,ì°¸ì—¬", answer: "ê° ì²´í—˜ê´€ì— ë¹„ì¹˜ëœ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ìŠ¤íƒ¬í”„ê°€ ìë™ ìˆ˜ì§‘ë©ë‹ˆë‹¤. ëª¨ë“  ìŠ¤íƒ¬í”„ë¥¼ ëª¨ìœ¼ë©´ DCC 2ì „ì‹œì¥ ì¢…í•©ì•ˆë‚´ì†Œì—ì„œ ê¸°ë…í’ˆì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”!" },
    { keywords: "ê¸°ë…í’ˆ,ì„ ë¬¼,ê²½í’ˆ,ìˆ˜ë ¹", answer: "ëª¨ë“  ìŠ¤íƒ¬í”„ë¥¼ ìˆ˜ì§‘í•˜ë©´ DCC 2ì „ì‹œì¥ ì¢…í•©ì•ˆë‚´ì†Œì—ì„œ ê¸°ë…í’ˆì„ ìˆ˜ë ¹í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ë…í’ˆ ì†Œì§„ ì‹œ ì¡°ê¸° ì¢…ë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
    { keywords: "í™”ì¥ì‹¤,í¸ì˜ì‹œì„¤,ìˆ˜ìœ ì‹¤", answer: "í™”ì¥ì‹¤ì€ ê° ì „ì‹œì¥ ë‚´ë¶€ì— ìœ„ì¹˜í•´ ìˆìœ¼ë©°, ìˆ˜ìœ ì‹¤ì€ ì¢…í•©ì•ˆë‚´ì†Œ ì˜†ì— ë§ˆë ¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤." },
    { keywords: "ìŒì‹,ë¨¹ê±°ë¦¬,ì‹ë‹¹,ë°¥,ì¹´í˜", answer: "í‘¸ë“œì½”íŠ¸ëŠ” ì•¼ì™¸ ê´‘ì¥ì— ìœ„ì¹˜í•´ ìˆìœ¼ë©°, ë‹¤ì–‘í•œ ë¨¹ê±°ë¦¬ë¥¼ ì¦ê¸°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
  ],
  aiCharImage: null,
  linkHome: { icon: "ğŸŒ", label: "í™ˆí˜ì´ì§€", url: "" },
  linkSns: { icon: "ğŸ“¸", label: "SNS", url: "" },
  heroImage: null,
  stampImage: null,
  stampEmptyImage: null,
  mapImage: null,
  locations: [
    { id: "loc1", name: "ê³¼í•™ì²´í—˜ê´€", icon: "ğŸ”¬", code: "DJSF2026-A1", mission: "ê³¼í•™ì²´í—˜ê´€ì—ì„œ VR ìš°ì£¼íƒí—˜ì„ ì²´í—˜í•˜ê³  ìŠ¤íƒ¬í”„ë¥¼ ë°›ìœ¼ì„¸ìš”!", desc: "ì²¨ë‹¨ ê³¼í•™ê¸°ìˆ ì„ ì§ì ‘ ì²´í—˜í•  ìˆ˜ ìˆëŠ” ê³µê°„", iconImage: null },
    { id: "loc2", name: "ë¡œì¼“ì „ì‹œì¥", icon: "ğŸš€", code: "DJSF2026-B2", mission: "í•œêµ­í˜• ë°œì‚¬ì²´ ëˆ„ë¦¬í˜¸ ëª¨í˜• ì•ì—ì„œ ìŠ¤íƒ¬í”„ë¥¼ ë°›ìœ¼ì„¸ìš”!", desc: "ìš°ì£¼ ë°œì‚¬ì²´ì™€ ìœ„ì„±ì˜ ì—­ì‚¬ë¥¼ í•œëˆˆì—", iconImage: null },
    { id: "loc3", name: "AIë¡œë´‡ê´€", icon: "ğŸ¤–", code: "DJSF2026-C3", mission: "AI ë¡œë´‡ê³¼ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ê³  ìŠ¤íƒ¬í”„ë¥¼ ë°›ìœ¼ì„¸ìš”!", desc: "ì¸ê³µì§€ëŠ¥ê³¼ ë¡œë´‡ì˜ ë¯¸ë˜ë¥¼ ë§Œë‚˜ëŠ” ê³³", iconImage: null },
    { id: "loc4", name: "ìƒëª…ê³¼í•™ê´€", icon: "ğŸ§¬", code: "DJSF2026-D4", mission: "DNA ì¶”ì¶œ ì²´í—˜ì„ ì™„ë£Œí•˜ê³  ìŠ¤íƒ¬í”„ë¥¼ ë°›ìœ¼ì„¸ìš”!", desc: "ìƒëª…ì˜ ì‹ ë¹„ë¥¼ íƒêµ¬í•˜ëŠ” ì²´í—˜ ê³µê°„", iconImage: null },
    { id: "loc5", name: "ì—ë„ˆì§€íŒŒë¹Œë¦¬ì˜¨", icon: "âš¡", code: "DJSF2026-E5", mission: "ì‹ ì¬ìƒì—ë„ˆì§€ í€´ì¦ˆë¥¼ í’€ê³  ìŠ¤íƒ¬í”„ë¥¼ ë°›ìœ¼ì„¸ìš”!", desc: "ë¯¸ë˜ ì—ë„ˆì§€ ê¸°ìˆ ì„ ë°°ìš°ëŠ” ì¹œí™˜ê²½ ê³µê°„", iconImage: null },
    { id: "loc6", name: "ì²œë¬¸ìš°ì£¼ê´€", icon: "ğŸŒŒ", code: "DJSF2026-F6", mission: "ì²œì²´ë§ì›ê²½ìœ¼ë¡œ ë³„ì„ ê´€ì¸¡í•˜ê³  ìŠ¤íƒ¬í”„ë¥¼ ë°›ìœ¼ì„¸ìš”!", desc: "ë³„ê³¼ ìš°ì£¼ì˜ ì‹ ë¹„ë¥¼ íƒí—˜í•˜ëŠ” ê³³", iconImage: null },
  ],
};

const ADMIN_PASSWORD = "0460";
const RESET_PASSWORD = "4466";
const EMOJI_LIST = ["ğŸ”¬","ğŸš€","ğŸ¤–","ğŸ§¬","âš¡","ğŸŒŒ","ğŸª","ğŸ­","ğŸ¨","ğŸµ","ğŸ›","ğŸŒ³","ğŸ¡","ğŸ¢","ğŸ¯","ğŸ†","â­","ğŸ’","ğŸ”­","ğŸ§ª","ğŸ§²","ğŸŒ","â˜€ï¸","ğŸŒŠ","ğŸ¦•","ğŸ‰","ğŸ“","ğŸ“¡","ğŸ’¡","ğŸˆ","ğŸ","ğŸ…","ğŸ”®","ğŸ›¸","ğŸŒˆ","ğŸ¶","ğŸ–¼","ğŸ—¿","â›©","ğŸ°"];

const BG_THEMES = [
  { id: "none", name: "ì—†ìŒ", icon: "â¬œ", desc: "ë‹¨ìƒ‰ ê·¸ë¼ë°ì´ì…˜" },
  { id: "space", name: "ìš°ì£¼", icon: "ğŸŒŒ", desc: "ë³„ì´ ë°˜ì§ì´ëŠ” ìš°ì£¼ ê³µê°„" },
  { id: "atom", name: "ì›ì", icon: "âš›ï¸", desc: "ê¶¤ë„ë¥¼ ë„ëŠ” ì „ì ì…ì" },
  { id: "dna", name: "DNA", icon: "ğŸ§¬", desc: "ë– ë‹¤ë‹ˆëŠ” ì´ì¤‘ë‚˜ì„  ë¶„ì" },
  { id: "circuit", name: "íšŒë¡œ", icon: "ğŸ”¬", desc: "ì „ìíšŒë¡œ ë„¤ì˜¨ ë¼ì¸" },
  { id: "rocket", name: "ë¡œì¼“", icon: "ğŸš€", desc: "ë³„ë¹› ì† ë°œì‚¬ì²´ ê¶¤ì " },
  { id: "bubble", name: "ë²„ë¸”", icon: "ğŸ§ª", desc: "ê³¼í•™ ì‹¤í—˜ ê¸°í¬" },
];

function App() {
  const [config, setConfig] = useState(DEFAULT_CONFIG);
  const [screen, setScreen] = useState("loading");
  const [user, setUser] = useState(null);
  const [stamps, setStamps] = useState({});
  const [showAdmin, setShowAdmin] = useState(false);
  const [adminAuth, setAdminAuth] = useState(false);
  const [adminPw, setAdminPw] = useState("");
  const [adminTab, setAdminTab] = useState("locations");
  const [chatMessages, setChatMessages] = useState([]);
  const [chatInput, setChatInput] = useState("");
  const [chatLoading, setChatLoading] = useState(false);
  const [scanResult, setScanResult] = useState(null);
  const [regForm, setRegForm] = useState({ name: "", birth: "", phone: "", agree: false });
  const [showComplete, setShowComplete] = useState(false);
  const [editLoc, setEditLoc] = useState(null);
  const [participants, setParticipants] = useState([]);
  const [adminPwError, setAdminPwError] = useState(false);
  const [showMap, setShowMap] = useState(false);
  const [showEmojiPicker, setShowEmojiPicker] = useState(null);
  const [scanning, setScanning] = useState(false);
  const [cameraError, setCameraError] = useState(null);
  const [toast, setToast] = useState(null);
  const [adminHover, setAdminHover] = useState(false);
  const [showReturnPrompt, setShowReturnPrompt] = useState(false);
  const [returnUser, setReturnUser] = useState(null);
  const [isCompleted, setIsCompleted] = useState(false);

  const chatEndRef = useRef(null);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const streamRef = useRef(null);
  const scanActiveRef = useRef(false);
  const detectorRef = useRef(null);
  const jsQRRef = useRef(null);
  const toastTimer = useRef(null);

  // â”€â”€â”€ Toast notification â”€â”€â”€
  const showToast = (msg, type = "success") => {
    clearTimeout(toastTimer.current);
    setToast({ msg, type });
    toastTimer.current = setTimeout(() => setToast(null), 2200);
  };

  // â”€â”€â”€ Load everything on mount â”€â”€â”€
  useEffect(() => {
    (async () => {
      // Config priority: EMBEDDED_CONFIG (exported HTML) > localStorage > DEFAULT_CONFIG
      if (window.EMBEDDED_CONFIG) {
        setConfig({ ...DEFAULT_CONFIG, ...window.EMBEDDED_CONFIG });
      } else {
        try {
          const r = await window.storage.get("stamp-config-v2");
          if (r?.value) setConfig(JSON.parse(r.value));
        } catch {}
      }
      try {
        const r = await window.storage.get("stamp-participants-v2", true);
        if (r?.value) setParticipants(JSON.parse(r.value));
      } catch {}
      // Check for returning user
      let savedUser = null;
      let savedStamps = {};
      let savedCompleted = false;
      try {
        const r = await window.storage.get("stamp-user-v2");
        if (r?.value) savedUser = JSON.parse(r.value);
      } catch {}
      try {
        const r = await window.storage.get("stamp-progress-v2");
        if (r?.value) savedStamps = JSON.parse(r.value);
      } catch {}
      try {
        const r = await window.storage.get("stamp-completed-v2");
        if (r?.value) savedCompleted = JSON.parse(r.value);
      } catch {}

      if (savedUser) {
        setReturnUser(savedUser);
        setStamps(savedStamps);
        setIsCompleted(savedCompleted);
        setShowReturnPrompt(true);
        setScreen("register");
      } else {
        setScreen("register");
      }
    })();
  }, []);

  // â”€â”€â”€ Load jsQR as fallback â”€â”€â”€
  useEffect(() => {
    // Check native BarcodeDetector first
    if (typeof BarcodeDetector !== "undefined") {
      try { detectorRef.current = new BarcodeDetector({ formats: ["qr_code"] }); } catch {}
    }
    // Load jsQR as fallback
    if (window.jsQR) { jsQRRef.current = window.jsQR; return; }
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js";
    script.onload = () => { jsQRRef.current = window.jsQR; };
    document.head.appendChild(script);
  }, []);

  // â”€â”€â”€ Save helpers â”€â”€â”€
  const saveConfig = async (nc) => {
    setConfig(nc);
    try { await window.storage.set("stamp-config-v2", JSON.stringify(nc)); } catch {}
    showToast("âœ… ì €ì¥ ì™„ë£Œ!");
  };

  const saveParticipants = async (l) => {
    setParticipants(l);
    try { await window.storage.set("stamp-participants-v2", JSON.stringify(l), true); } catch {}
  };

  const saveUser = async (u) => {
    setUser(u);
    try { await window.storage.set("stamp-user-v2", JSON.stringify(u)); } catch {}
  };

  const saveStamps = async (s) => {
    setStamps(s);
    try { await window.storage.set("stamp-progress-v2", JSON.stringify(s)); } catch {}
  };

  const allStamped = config.locations.length > 0 && config.locations.every(l => stamps[l.id]);
  const stampCount = config.locations.filter(l => stamps[l.id]).length;

  useEffect(() => {
    if (allStamped && !showComplete && screen === "tour") {
      setShowComplete(true);
      setIsCompleted(true);
      (async () => { try { await window.storage.set("stamp-completed-v2", JSON.stringify(true)); } catch {} })();
    }
  }, [allStamped, screen]);
  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatMessages]);

  // â”€â”€â”€ Register â”€â”€â”€
  const handleRegister = () => {
    if (!regForm.name || !regForm.birth || !regForm.phone || !regForm.agree) return;
    const u = { name: regForm.name, birth: regForm.birth, phone: regForm.phone, time: new Date().toISOString() };
    saveUser(u);
    saveParticipants([...participants, u]);
    saveStamps({});
    setScreen("tour");
    showToast("ğŸ‰ ë“±ë¡ ì™„ë£Œ! íˆ¬ì–´ë¥¼ ì‹œì‘í•˜ì„¸ìš”!");
  };

  // â”€â”€â”€ Return user continue â”€â”€â”€
  const handleReturnContinue = () => {
    setUser(returnUser);
    setShowReturnPrompt(false);
    setScreen("tour");
    showToast(`ğŸ‘‹ ${returnUser.name}ë‹˜, ë‹¤ì‹œ ì˜¤ì…¨êµ°ìš”!`);
  };

  // â”€â”€â”€ QR Camera Scanner (BarcodeDetector native â†’ jsQR fallback) â”€â”€â”€
  const startScanner = async () => {
    setScanning(true);
    setCameraError(null);
    setScanResult(null);
    scanActiveRef.current = true;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
      });
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.setAttribute("playsinline", true);
        await videoRef.current.play();
        scanLoop();
      }
    } catch (err) {
      setCameraError(err.name === "NotAllowedError"
        ? "ì¹´ë©”ë¼ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”."
        : "ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  };

  const scanLoop = async () => {
    if (!scanActiveRef.current) return;
    const video = videoRef.current;
    if (!video || video.readyState < video.HAVE_ENOUGH_DATA) {
      setTimeout(scanLoop, 100);
      return;
    }

    // â”€â”€ Method 1: Native BarcodeDetector (hardware-accelerated, instant) â”€â”€
    if (detectorRef.current) {
      try {
        const barcodes = await detectorRef.current.detect(video);
        if (barcodes.length > 0 && barcodes[0].rawValue) {
          scanActiveRef.current = false;
          try { navigator.vibrate?.(200); } catch {}
          handleScannedCode(barcodes[0].rawValue);
          return;
        }
      } catch {}
      if (scanActiveRef.current) setTimeout(scanLoop, 120);
      return;
    }

    // â”€â”€ Method 2: jsQR fallback (software decode) â”€â”€
    const jsQR = jsQRRef.current || window.jsQR;
    if (!jsQR) {
      setTimeout(scanLoop, 200);
      return;
    }
    const canvas = canvasRef.current;
    if (!canvas) { setTimeout(scanLoop, 200); return; }
    const vw = video.videoWidth, vh = video.videoHeight;
    const scale = Math.min(1, 640 / Math.max(vw, vh));
    canvas.width = Math.round(vw * scale);
    canvas.height = Math.round(vh * scale);
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
    if (code?.data) {
      scanActiveRef.current = false;
      try { navigator.vibrate?.(200); } catch {}
      handleScannedCode(code.data);
      return;
    }
    if (scanActiveRef.current) setTimeout(scanLoop, 200);
  };

  const handleScannedCode = (data) => {
    const loc = config.locations.find(l => l.code === data);
    if (loc) {
      if (stamps[loc.id]) {
        setScanResult({ success: false, msg: `ì´ë¯¸ "${loc.name}" ìŠ¤íƒ¬í”„ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤!`, icon: "ğŸ”„" });
      } else {
        const ns = { ...stamps, [loc.id]: true };
        saveStamps(ns);
        setScanResult({ success: true, msg: `"${loc.name}" ìŠ¤íƒ¬í”„ íšë“!`, icon: "ğŸ‰" });
      }
    } else {
      setScanResult({ success: false, msg: "ìœ íš¨í•˜ì§€ ì•Šì€ QRì½”ë“œì…ë‹ˆë‹¤.", icon: "âŒ" });
    }
    stopScanner();
  };

  const stopScanner = () => {
    scanActiveRef.current = false;
    if (streamRef.current) { streamRef.current.getTracks().forEach(t => t.stop()); streamRef.current = null; }
    setScanning(false);
  };

  // â”€â”€â”€ Image Upload Helper â”€â”€â”€
  const handleImageUpload = (callback, maxSize = 800) => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          let w = img.width, h = img.height;
          if (w > maxSize || h > maxSize) {
            if (w > h) { h = (h / w) * maxSize; w = maxSize; }
            else { w = (w / h) * maxSize; h = maxSize; }
          }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0, 0, w, h);
          callback(canvas.toDataURL("image/png", 0.85));
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    };
    input.click();
  };

  // â”€â”€â”€ AI Chat (with API key support) â”€â”€â”€
  // â”€â”€â”€ FAQ keyword matching â”€â”€â”€
  const matchFaq = (question) => {
    const q = question.toLowerCase().replace(/[?ï¼Ÿï¼!.,\s]/g, "");
    if (!config.faqList || config.faqList.length === 0) return null;
    let bestMatch = null;
    let bestScore = 0;
    for (const faq of config.faqList) {
      if (!faq.keywords || !faq.answer) continue;
      const keywords = faq.keywords.split(",").map(k => k.trim().toLowerCase()).filter(Boolean);
      let score = 0;
      for (const kw of keywords) {
        if (q.includes(kw)) score++;
      }
      if (score > bestScore) { bestScore = score; bestMatch = faq; }
    }
    return bestScore > 0 ? bestMatch.answer : null;
  };

  const sendChat = async () => {
    if (!chatInput.trim() || chatLoading) return;
    const userMsg = chatInput.trim();
    setChatInput("");
    setChatMessages(prev => [...prev, { role: "user", text: userMsg }]);

    // Try FAQ first
    const faqAnswer = matchFaq(userMsg);

    // If no API key, use FAQ only mode
    const hasApi = config.apiKey && config.apiKey.trim();
    if (!hasApi) {
      setChatLoading(true);
      // Small delay for natural feel
      await new Promise(r => setTimeout(r, 400 + Math.random() * 600));
      if (faqAnswer) {
        setChatMessages(prev => [...prev, { role: "assistant", text: faqAnswer }]);
      } else {
        setChatMessages(prev => [...prev, { role: "assistant", text: `ì•ˆë‚´í•´ë“œë¦¬ì§€ ëª»í•´ ì£„ì†¡í•©ë‹ˆë‹¤ ğŸ™\n\nğŸ“ DCC 2ì „ì‹œì¥ ì¢…í•©ì•ˆë‚´ì†Œì—ì„œ ìì„¸íˆ ì•ˆë‚´ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nğŸ’¡ ì´ëŸ° ì§ˆë¬¸ì€ ë‹µë³€ ê°€ëŠ¥í•´ìš”:\n${(config.faqList || []).slice(0, 4).map(f => "â€¢ " + f.keywords.split(",")[0]).join("\n")}` }]);
      }
      setChatLoading(false);
      return;
    }

    // API mode (with FAQ boost)
    setChatLoading(true);
    try {
      const headers = { "Content-Type": "application/json", "x-api-key": config.apiKey.trim(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" };
      const res = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST", headers,
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514", max_tokens: 1000,
          system: `ë‹¹ì‹ ì€ "${config.festivalName}"ì˜ AI ì•ˆë‚´ ë§¤ë‹ˆì €ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì¹œì ˆí•˜ê³  ê°„ê²°í•˜ê²Œ(3-4ë¬¸ì¥) ë‹µë³€í•˜ì„¸ìš”.\n\n[ì¶•ì œ ì •ë³´]\n${config.festivalInfo}\n\n[ìŠ¤íƒ¬í”„ íˆ¬ì–´ ì¥ì†Œ]\n${config.locations.map((l, i) => `${i + 1}. ${l.name}: ${l.desc} - ë¯¸ì…˜: ${l.mission}`).join("\n")}\n\nì´ ${config.locations.length}ê°œ ì¥ì†Œ ë°©ë¬¸ â†’ QR ìŠ¤ìº” â†’ ìŠ¤íƒ¬í”„ ìˆ˜ì§‘ â†’ DCC 2ì „ì‹œì¥ ì¢…í•©ì•ˆë‚´ì†Œì—ì„œ ê¸°ë…í’ˆ ìˆ˜ë ¹\nâ€» ê¸°ë…í’ˆ ì†Œì§„ ì‹œ ì´ë²¤íŠ¸ê°€ ì¡°ê¸° ì¢…ë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
          messages: [...chatMessages.slice(-10).map(m => ({ role: m.role === "user" ? "user" : "assistant", content: m.text })), { role: "user", content: userMsg }],
        }),
      });
      if (!res.ok) throw new Error(res.status === 401 || res.status === 403 ? "API_KEY" : "API ì˜¤ë¥˜");
      const data = await res.json();
      setChatMessages(prev => [...prev, { role: "assistant", text: data.content?.map(c => c.text || "").join("") || "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." }]);
    } catch (err) {
      // API failed â†’ fallback to FAQ
      if (faqAnswer) {
        setChatMessages(prev => [...prev, { role: "assistant", text: faqAnswer }]);
      } else {
        setChatMessages(prev => [...prev, { role: "assistant", text: "âš ï¸ ì¼ì‹œì ìœ¼ë¡œ AI ì‘ë‹µì´ ë¶ˆê°€í•©ë‹ˆë‹¤.\nğŸ“ ì¢…í•©ì•ˆë‚´ì†Œì—ì„œ ì•ˆë‚´ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤." }]);
      }
    }
    setChatLoading(false);
  };

  // â”€â”€â”€ QR Code Image URL â”€â”€â”€
  const getQRUrl = (data, size = 200) => `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(data)}&format=png&margin=8`;

  const css = { fontFamily: config.fontFamily, "--p": config.primaryColor, "--s": config.secondaryColor, "--a": config.accentColor };

  // â”€â”€â”€ Toast Component â”€â”€â”€
  const ToastNotification = () => {
    if (!toast) return null;
    return (
      <div style={{
        position: "fixed", top: 20, left: "50%", transform: "translateX(-50%)",
        background: toast.type === "success" ? "#059669" : toast.type === "error" ? "#dc2626" : "#1e293b",
        color: "#fff", padding: "12px 24px", borderRadius: 14, fontSize: 14, fontWeight: 700,
        zIndex: 9999, boxShadow: "0 8px 32px rgba(0,0,0,0.3)",
        animation: "toastIn 0.3s ease-out", whiteSpace: "nowrap",
        backdropFilter: "blur(10px)", letterSpacing: 0.5
      }}>
        {toast.msg}
      </div>
    );
  };

  // â”€â”€â”€ Admin Button (invisible by default, appears on hover/touch) â”€â”€â”€
  const AdminButton = () => {
    if (screen === "chat" || scanning || scanResult) return null;
    return (
      <div
        onMouseEnter={() => setAdminHover(true)}
        onMouseLeave={() => setAdminHover(false)}
        onTouchStart={() => setAdminHover(true)}
        onClick={() => { if (adminHover) setShowAdmin(true); }}
        style={{
          position: "fixed", top: 0, right: 0, zIndex: 999,
          width: adminHover ? "auto" : 44, height: adminHover ? 40 : 44,
          borderRadius: adminHover ? "0 0 0 16px" : 0, cursor: "pointer",
          background: adminHover ? "rgba(0,0,0,0.7)" : "transparent",
          backdropFilter: adminHover ? "blur(8px)" : "none",
          display: "flex", alignItems: "center", justifyContent: "center", gap: 6,
          padding: adminHover ? "0 14px 0 12px" : "0",
          transition: "all 0.3s ease",
          opacity: adminHover ? 1 : 0,
        }}
      >
        <span style={{ fontSize: 16 }}>âš™ï¸</span>
        {adminHover && <span style={{ color: "#fff", fontSize: 12, fontWeight: 700, whiteSpace: "nowrap" }}>ê´€ë¦¬ì</span>}
      </div>
    );
  };

  // â”€â”€â”€ Admin Password Modal (0460=ê´€ë¦¬ì / 4466=ì´ˆê¸°í™”) â”€â”€â”€
  const handleAdminSubmit = () => {
    if (adminPw === ADMIN_PASSWORD) {
      setAdminAuth(true); setAdminPw(""); setScreen("admin"); setShowAdmin(false); setAdminPwError(false);
    } else if (adminPw === RESET_PASSWORD) {
      // Reset current user stamps
      setStamps({});
      setIsCompleted(false);
      setShowComplete(false);
      setAdminPw(""); setShowAdmin(false); setAdminPwError(false);
      (async () => {
        try { await window.storage.set("stamp-progress-v2", JSON.stringify({})); } catch {}
        try { await window.storage.set("stamp-completed-v2", JSON.stringify(false)); } catch {}
      })();
      if (user) {
        showToast("ğŸ”„ ìŠ¤íƒ¬í”„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤! ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!");
      } else if (returnUser) {
        setUser(returnUser);
        setShowReturnPrompt(false);
        setScreen("tour");
        showToast("ğŸ”„ ì´ˆê¸°í™” ì™„ë£Œ! ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!");
      } else {
        showToast("ğŸ”„ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
    } else {
      setAdminPwError(true);
    }
  };

  const AdminPwModal = () => (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.6)", zIndex: 2000, display: "flex", alignItems: "center", justifyContent: "center", padding: 20, backdropFilter: "blur(4px)" }}>
      <div style={{ background: "#fff", borderRadius: 20, padding: "28px 24px", width: "100%", maxWidth: 320, textAlign: "center", boxShadow: "0 20px 60px rgba(0,0,0,0.3)" }}>
        <div style={{ fontSize: 32, marginBottom: 8 }}>ğŸ”</div>
        <p style={{ fontSize: 15, fontWeight: 700, marginBottom: 18, color: "#333" }}>ê´€ë¦¬ì ì¸ì¦</p>
        <input type="password" inputMode="numeric" value={adminPw} onChange={e => { setAdminPw(e.target.value); setAdminPwError(false); }} placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" maxLength={10} style={{ width: "100%", padding: 14, borderRadius: 12, border: `2px solid ${adminPwError ? "#ef4444" : "#e2e8f0"}`, fontSize: 18, textAlign: "center", boxSizing: "border-box", outline: "none", letterSpacing: 8 }} onKeyDown={e => { if (e.key === "Enter") handleAdminSubmit(); }} autoFocus />
        {adminPwError && <p style={{ color: "#ef4444", fontSize: 12, marginTop: 8 }}>ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤</p>}
        <div style={{ display: "flex", gap: 10, marginTop: 18 }}>
          <button onClick={() => { setShowAdmin(false); setAdminPw(""); setAdminPwError(false); }} style={{ flex: 1, padding: 12, borderRadius: 10, border: "1px solid #e2e8f0", background: "#f8fafc", cursor: "pointer", fontSize: 14 }}>ì·¨ì†Œ</button>
          <button onClick={handleAdminSubmit} style={{ flex: 1, padding: 12, borderRadius: 10, border: "none", background: config.primaryColor, color: "#fff", cursor: "pointer", fontSize: 14, fontWeight: 700 }}>í™•ì¸</button>
        </div>
      </div>
    </div>
  );

  // â”€â”€â”€ Background Theme Animation â”€â”€â”€
  const BgAnimation = ({ theme }) => {
    if (!theme || theme === "none") return (
      <div style={{ position: "fixed", inset: 0, overflow: "hidden", pointerEvents: "none", zIndex: 0 }}>
        {[...Array(6)].map((_, i) => <div key={i} style={{ position: "absolute", width: 6, height: 6, borderRadius: "50%", background: "rgba(255,255,255,0.12)", left: `${15 + i * 15}%`, top: "-10%", animation: `floatDown ${8 + i * 2}s linear infinite`, animationDelay: `${i * 1.5}s` }} />)}
      </div>
    );

    if (theme === "space") return (
      <div style={{ position: "fixed", inset: 0, overflow: "hidden", pointerEvents: "none", zIndex: 0 }}>
        {/* Static twinkling stars */}
        {[...Array(40)].map((_, i) => <div key={`s${i}`} style={{ position: "absolute", width: i % 3 === 0 ? 3 : 2, height: i % 3 === 0 ? 3 : 2, borderRadius: "50%", background: "#fff", left: `${(i * 37 + 13) % 100}%`, top: `${(i * 23 + 7) % 100}%`, opacity: 0.15 + (i % 5) * 0.15, animation: `twinkle ${2 + (i % 4)}s ease-in-out infinite`, animationDelay: `${(i * 0.3) % 3}s` }} />)}
        {/* Shooting stars */}
        {[...Array(3)].map((_, i) => <div key={`sh${i}`} style={{ position: "absolute", width: 60 + i * 20, height: 2, background: `linear-gradient(90deg, transparent, rgba(255,255,255,${0.6 - i * 0.15}), transparent)`, top: `${15 + i * 25}%`, left: "-20%", borderRadius: 2, animation: `shootStar ${4 + i * 2}s linear infinite`, animationDelay: `${i * 3}s`, transform: "rotate(-15deg)" }} />)}
        {/* Nebula glow */}
        <div style={{ position: "absolute", width: "60vw", height: "60vw", borderRadius: "50%", background: "radial-gradient(circle, rgba(100,100,255,0.08) 0%, transparent 70%)", top: "10%", right: "-20%", animation: "nebulaPulse 8s ease-in-out infinite" }} />
        <div style={{ position: "absolute", width: "40vw", height: "40vw", borderRadius: "50%", background: "radial-gradient(circle, rgba(200,100,255,0.06) 0%, transparent 70%)", bottom: "20%", left: "-10%", animation: "nebulaPulse 10s ease-in-out infinite", animationDelay: "3s" }} />
      </div>
    );

    if (theme === "atom") return (
      <div style={{ position: "fixed", inset: 0, overflow: "hidden", pointerEvents: "none", zIndex: 0 }}>
        {/* Orbit rings */}
        {[...Array(3)].map((_, i) => <div key={`o${i}`} style={{ position: "absolute", width: 200 + i * 100, height: 200 + i * 100, borderRadius: "50%", border: `1px solid rgba(255,255,255,${0.06 + i * 0.02})`, left: "50%", top: "40%", transform: "translate(-50%, -50%)", animation: `orbitSpin ${10 + i * 5}s linear infinite ${i % 2 === 0 ? "" : "reverse"}` }} />)}
        {/* Electrons */}
        {[...Array(6)].map((_, i) => <div key={`e${i}`} style={{ position: "absolute", width: 8, height: 8, borderRadius: "50%", background: `rgba(${100 + i * 30},${200 - i * 20},255,${0.3 + (i % 3) * 0.15})`, boxShadow: `0 0 ${8 + i * 3}px rgba(100,200,255,0.3)`, animation: `electronFloat ${5 + i * 1.5}s ease-in-out infinite`, left: `${10 + i * 15}%`, top: `${20 + (i * 37) % 60}%`, animationDelay: `${i * 0.8}s` }} />)}
        {/* Nucleus glow */}
        <div style={{ position: "absolute", width: 16, height: 16, borderRadius: "50%", background: "radial-gradient(circle, rgba(255,200,100,0.25), transparent)", left: "50%", top: "40%", transform: "translate(-50%,-50%)", boxShadow: "0 0 40px rgba(255,200,100,0.15)" }} />
      </div>
    );

    if (theme === "dna") return (
      <div style={{ position: "fixed", inset: 0, overflow: "hidden", pointerEvents: "none", zIndex: 0 }}>
        {/* Double helix dots */}
        {[...Array(16)].map((_, i) => {
          const y = i * 7;
          const phase = i * 0.6;
          return [
            <div key={`a${i}`} style={{ position: "absolute", width: 6, height: 6, borderRadius: "50%", background: `rgba(100,220,255,${0.2 + (i % 3) * 0.1})`, left: `${48 + Math.sin(phase) * 12}%`, top: `${y}%`, animation: `helixWave ${6}s ease-in-out infinite`, animationDelay: `${i * 0.2}s`, boxShadow: "0 0 6px rgba(100,220,255,0.2)" }} />,
            <div key={`b${i}`} style={{ position: "absolute", width: 6, height: 6, borderRadius: "50%", background: `rgba(255,150,200,${0.2 + (i % 3) * 0.1})`, left: `${52 - Math.sin(phase) * 12}%`, top: `${y}%`, animation: `helixWave ${6}s ease-in-out infinite`, animationDelay: `${i * 0.2 + 0.3}s`, boxShadow: "0 0 6px rgba(255,150,200,0.2)" }} />,
            i % 2 === 0 && <div key={`c${i}`} style={{ position: "absolute", height: 1, background: `rgba(255,255,255,0.06)`, left: `${48 + Math.sin(phase) * 12}%`, width: `${Math.abs(Math.sin(phase)) * 8}%`, top: `${y + 0.3}%` }} />
          ];
        })}
      </div>
    );

    if (theme === "circuit") return (
      <div style={{ position: "fixed", inset: 0, overflow: "hidden", pointerEvents: "none", zIndex: 0 }}>
        {/* Circuit lines */}
        {[...Array(8)].map((_, i) => <div key={`cl${i}`} style={{ position: "absolute", background: `rgba(0,255,200,${0.04 + (i % 3) * 0.02})`, ...(i % 2 === 0 ? { width: 1, height: `${30 + i * 10}%`, left: `${12 + i * 11}%`, top: `${(i * 17) % 40}%` } : { height: 1, width: `${25 + i * 8}%`, top: `${15 + i * 10}%`, left: `${(i * 13) % 50}%` }) }} />)}
        {/* Node dots */}
        {[...Array(10)].map((_, i) => <div key={`nd${i}`} style={{ position: "absolute", width: 5, height: 5, borderRadius: "50%", background: `rgba(0,255,200,${0.15 + (i % 3) * 0.1})`, boxShadow: `0 0 8px rgba(0,255,200,0.2)`, left: `${(i * 31 + 10) % 90}%`, top: `${(i * 23 + 5) % 90}%`, animation: `circuitPulse ${2 + i % 3}s ease-in-out infinite`, animationDelay: `${i * 0.4}s` }} />)}
        {/* Data flow */}
        {[...Array(4)].map((_, i) => <div key={`df${i}`} style={{ position: "absolute", width: 3, height: 3, borderRadius: "50%", background: "rgba(0,255,200,0.5)", animation: `dataFlow${i % 2 === 0 ? "V" : "H"} ${3 + i}s linear infinite`, animationDelay: `${i * 1.5}s`, left: `${12 + i * 22}%`, top: `${15 + i * 10}%` }} />)}
      </div>
    );

    if (theme === "rocket") return (
      <div style={{ position: "fixed", inset: 0, overflow: "hidden", pointerEvents: "none", zIndex: 0 }}>
        {/* Speed stars streaming upward */}
        {[...Array(20)].map((_, i) => <div key={`rs${i}`} style={{ position: "absolute", width: 2, height: 8 + (i % 3) * 6, background: `linear-gradient(to top, transparent, rgba(255,255,255,${0.1 + (i % 4) * 0.08}))`, borderRadius: 2, left: `${(i * 19 + 5) % 100}%`, bottom: "-5%", animation: `rocketStar ${2 + (i % 4) * 0.5}s linear infinite`, animationDelay: `${(i * 0.3) % 3}s` }} />)}
        {/* Exhaust glow */}
        <div style={{ position: "absolute", width: "30vw", height: "30vw", borderRadius: "50%", background: "radial-gradient(circle, rgba(255,150,50,0.08) 0%, transparent 70%)", bottom: "-10%", left: "35%", animation: "nebulaPulse 4s ease-in-out infinite" }} />
        {/* Small stars */}
        {[...Array(15)].map((_, i) => <div key={`ss${i}`} style={{ position: "absolute", width: 2, height: 2, borderRadius: "50%", background: "#fff", opacity: 0.1 + (i % 5) * 0.1, left: `${(i * 29 + 3) % 100}%`, top: `${(i * 17 + 5) % 100}%`, animation: `twinkle ${2 + i % 3}s ease-in-out infinite`, animationDelay: `${i * 0.4}s` }} />)}
      </div>
    );

    if (theme === "bubble") return (
      <div style={{ position: "fixed", inset: 0, overflow: "hidden", pointerEvents: "none", zIndex: 0 }}>
        {[...Array(12)].map((_, i) => <div key={`bb${i}`} style={{ position: "absolute", width: 12 + (i % 4) * 8, height: 12 + (i % 4) * 8, borderRadius: "50%", border: `1px solid rgba(255,255,255,${0.06 + (i % 3) * 0.04})`, background: `radial-gradient(circle at 35% 35%, rgba(255,255,255,${0.06 + (i % 3) * 0.03}), transparent)`, left: `${(i * 23 + 5) % 95}%`, bottom: "-10%", animation: `bubbleUp ${6 + (i % 5) * 2}s ease-in infinite`, animationDelay: `${(i * 0.7) % 5}s` }} />)}
      </div>
    );

    return null;
  };

  // â”€â”€â”€ Stamp Visual â”€â”€â”€
  const StampIcon = ({ loc, size = 48, stamped = false }) => {
    if (stamped && config.stampImage) return <img src={config.stampImage} alt="" style={{ width: size, height: size, borderRadius: size * 0.25, objectFit: "cover" }} />;
    if (!stamped && config.stampEmptyImage) return <img src={config.stampEmptyImage} alt="" style={{ width: size, height: size, borderRadius: size * 0.25, objectFit: "cover", opacity: 0.5 }} />;
    if (loc?.iconImage) return <div style={{ width: size, height: size, borderRadius: size * 0.25, overflow: "hidden", border: stamped ? `3px solid ${config.accentColor}` : "3px solid #e2e8f0" }}><img src={loc.iconImage} alt="" style={{ width: "100%", height: "100%", objectFit: "cover" }} /></div>;
    return (
      <div style={{ width: size, height: size, borderRadius: "50%", background: stamped ? `linear-gradient(135deg, ${config.accentColor}, ${config.secondaryColor})` : "#e2e8f0", display: "flex", alignItems: "center", justifyContent: "center", fontSize: size * 0.45, color: stamped ? "#fff" : "#b0b8c4", fontWeight: 800, transition: "all 0.4s cubic-bezier(0.34,1.56,0.64,1)", boxShadow: stamped ? `0 4px 16px ${config.accentColor}55` : "inset 0 2px 4px rgba(0,0,0,0.06)", transform: stamped ? "scale(1)" : "scale(0.92)" }}>
        {stamped ? "âœ“" : (loc?.icon || "?")}
      </div>
    );
  };

  // â”€â”€â”€ AI Avatar (customizable) â”€â”€â”€
  const AiAvatar = ({ size = 30 }) => {
    if (config.aiCharImage) {
      return <img src={config.aiCharImage} alt="AI" style={{ width: size, height: size, borderRadius: "50%", objectFit: "cover", flexShrink: 0, border: "2px solid rgba(255,255,255,0.2)" }} />;
    }
    return (
      <div style={{ width: size, height: size, borderRadius: "50%", background: `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: size * 0.47, flexShrink: 0 }}>ğŸ¤–</div>
    );
  };

  // â”€â”€â”€ Large AI Avatar (for chat empty state) â”€â”€â”€
  const AiAvatarLarge = () => {
    if (config.aiCharImage) {
      return <img src={config.aiCharImage} alt="AI" style={{ width: 72, height: 72, borderRadius: "50%", objectFit: "cover", marginBottom: 8, border: `3px solid ${config.primaryColor}22` }} />;
    }
    return <div style={{ fontSize: 44, marginBottom: 8 }}>ğŸ¤–</div>;
  };

  // â”€â”€â”€ Loading screen â”€â”€â”€
  if (screen === "loading") return (
    <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: `linear-gradient(160deg, ${config.primaryColor}, ${config.secondaryColor})` }}>
      <div style={{ textAlign: "center", color: "#fff" }}>
        <div style={{ fontSize: 48, marginBottom: 12, animation: "heroFloat 2s ease-in-out infinite" }}>ğŸ”¬</div>
        <p style={{ fontSize: 14, opacity: 0.8 }}>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      <style>{`@keyframes heroFloat { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }`}</style>
    </div>
  );

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â–ˆâ–ˆ REGISTER SCREEN
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  if (screen === "register") return (
    <div style={{ ...css, minHeight: "100vh", background: `linear-gradient(160deg, ${config.primaryColor} 0%, ${config.secondaryColor} 100%)`, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 20, position: "relative" }}>
      <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700;900&family=Jua&family=Do+Hyeon&family=Gugi&family=Gaegu&family=Gamja+Flower&family=Gothic+A1:wght@400;700&display=swap" rel="stylesheet" />
      <ToastNotification />
      <AdminButton />
      {showAdmin && !adminAuth && <AdminPwModal />}

      {/* Background theme */}
      <BgAnimation theme={config.bgTheme} />

      {/* Hero */}
      {config.heroImage ? (
        <img src={config.heroImage} alt="" style={{ width: 140, height: 140, objectFit: "contain", marginBottom: 10, filter: "drop-shadow(0 8px 24px rgba(0,0,0,0.3))", animation: "heroFloat 3s ease-in-out infinite" }} />
      ) : (
        <div style={{ width: 120, height: 120, borderRadius: "50%", background: "rgba(255,255,255,0.15)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 56, marginBottom: 10, backdropFilter: "blur(10px)", border: "2px solid rgba(255,255,255,0.2)", animation: "heroFloat 3s ease-in-out infinite" }}>ğŸ”¬</div>
      )}

      <h1 style={{ fontFamily: config.titleFont, fontSize: 28, color: "#fff", margin: "0 0 4px", textShadow: "0 3px 12px rgba(0,0,0,0.3)", textAlign: "center" }}>{config.festivalName}</h1>
      <p style={{ color: "rgba(255,255,255,0.85)", fontSize: 14, letterSpacing: 3, marginBottom: 24, fontWeight: 500 }}>{config.subtitle}</p>

      {/* â”€â”€â”€ Return User Prompt â”€â”€â”€ */}
      {showReturnPrompt && returnUser && (
        <div style={{ background: "rgba(255,255,255,0.97)", borderRadius: 24, padding: "28px 22px", width: "100%", maxWidth: 380, boxShadow: "0 24px 64px rgba(0,0,0,0.2)", backdropFilter: "blur(20px)", animation: "bounceIn 0.4s" }}>
          <div style={{ textAlign: "center", marginBottom: 16 }}>
            <div style={{ fontSize: 44, marginBottom: 8 }}>{isCompleted ? "ğŸ†" : "ğŸ‘‹"}</div>
            <h2 style={{ fontSize: 18, fontWeight: 800, color: config.textColor, margin: "0 0 6px" }}>{isCompleted ? "ì´ë¯¸ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤!" : "ë‹¤ì‹œ ì˜¤ì…¨êµ°ìš”!"}</h2>
            <p style={{ fontSize: 14, color: "#64748b" }}><strong style={{ color: config.primaryColor }}>{returnUser.name}</strong>ë‹˜{isCompleted ? "ì€ ìŠ¤íƒ¬í”„ íˆ¬ì–´ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤" : "ì˜ ì§„í–‰ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤"}</p>
          </div>

          <div style={{ background: `${config.primaryColor}08`, borderRadius: 14, padding: 16, marginBottom: 16 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
              <span style={{ fontSize: 13, fontWeight: 600, color: "#475569" }}>ìˆ˜ì§‘í•œ ìŠ¤íƒ¬í”„</span>
              <span style={{ fontSize: 18, fontWeight: 900, color: isCompleted ? config.accentColor : config.primaryColor }}>{Object.keys(stamps).filter(k => stamps[k]).length} / {config.locations.length}</span>
            </div>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap", justifyContent: "center" }}>
              {config.locations.map(loc => (
                <div key={loc.id} style={{ width: 32, height: 32, borderRadius: "50%", background: stamps[loc.id] ? config.accentColor : "#e2e8f0", display: "flex", alignItems: "center", justifyContent: "center", fontSize: stamps[loc.id] ? 11 : 14, color: stamps[loc.id] ? "#fff" : "#b0b8c4" }}>
                  {stamps[loc.id] ? "âœ“" : loc.icon}
                </div>
              ))}
            </div>
          </div>

          {isCompleted ? (
            <div>
              <div style={{ padding: 14, background: "#ecfdf5", borderRadius: 12, marginBottom: 14, textAlign: "center" }}>
                <p style={{ fontSize: 13, color: "#065f46", fontWeight: 600, lineHeight: 1.6 }}>âœ… ìŠ¤íƒ¬í”„ íˆ¬ì–´ëŠ” 1ì¸ 1íšŒë§Œ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br />ğŸ“ DCC 2ì „ì‹œì¥ ì¢…í•©ì•ˆë‚´ì†Œì—ì„œ ê¸°ë…í’ˆì„ ìˆ˜ë ¹í•´ì£¼ì„¸ìš”!<br /><span style={{ fontSize: 11, fontWeight: 400, color: "#64748b" }}>â€» ê¸°ë…í’ˆ ì†Œì§„ ì‹œ ì´ë²¤íŠ¸ê°€ ì¡°ê¸° ì¢…ë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></p>
              </div>
              <button onClick={handleReturnContinue} style={{ width: "100%", padding: 15, borderRadius: 14, border: "none", background: `linear-gradient(135deg, ${config.accentColor}, #f59e0b)`, color: "#fff", fontSize: 17, fontWeight: 800, cursor: "pointer", fontFamily: config.titleFont, letterSpacing: 1 }}>
                ğŸ† ì™„ë£Œ í™”ë©´ ë³´ê¸°
              </button>
            </div>
          ) : (
            <div>
              <button onClick={handleReturnContinue} style={{ width: "100%", padding: 15, borderRadius: 14, border: "none", background: `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})`, color: "#fff", fontSize: 17, fontWeight: 800, cursor: "pointer", fontFamily: config.titleFont, letterSpacing: 1, boxShadow: `0 6px 24px ${config.primaryColor}44` }}>
                ğŸš€ ì´ì–´ì„œ íˆ¬ì–´í•˜ê¸°
              </button>
              <p style={{ textAlign: "center", fontSize: 11, color: "#94a3b8", marginTop: 12 }}>âš ï¸ ìŠ¤íƒ¬í”„ íˆ¬ì–´ëŠ” 1ì¸ 1íšŒë§Œ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
            </div>
          )}
        </div>
      )}

      {/* â”€â”€â”€ New Registration Form â”€â”€â”€ */}
      {!showReturnPrompt && (
        <div style={{ background: "rgba(255,255,255,0.97)", borderRadius: 24, padding: "28px 22px", width: "100%", maxWidth: 380, boxShadow: "0 24px 64px rgba(0,0,0,0.2)", backdropFilter: "blur(20px)" }}>
          <h2 style={{ fontSize: 17, fontWeight: 800, color: config.textColor, marginBottom: 20, textAlign: "center" }}>ğŸ« ì°¸ì—¬ ë“±ë¡</h2>

          {[
            { key: "name", label: "ì´ë¦„", ph: "í™ê¸¸ë™", type: "text" },
            { key: "birth", label: "ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ (6ìë¦¬)", ph: "990101", type: "numeric", max: 6 },
            { key: "phone", label: "íœ´ëŒ€í° ë²ˆí˜¸", ph: "010-1234-5678", type: "tel" },
          ].map(f => (
            <div key={f.key} style={{ marginBottom: 14 }}>
              <label style={{ fontSize: 12, fontWeight: 600, color: "#64748b", display: "block", marginBottom: 5 }}>{f.label}</label>
              <input value={regForm[f.key]} inputMode={f.type === "numeric" ? "numeric" : f.type === "tel" ? "tel" : "text"} maxLength={f.max || 20} onChange={e => {
                let v = e.target.value;
                if (f.key === "birth") v = v.replace(/\D/g, "").slice(0, 6);
                if (f.key === "phone") { v = v.replace(/\D/g, "").slice(0, 11); if (v.length > 7) v = v.slice(0, 3) + "-" + v.slice(3, 7) + "-" + v.slice(7); else if (v.length > 3) v = v.slice(0, 3) + "-" + v.slice(3); }
                setRegForm(p => ({ ...p, [f.key]: v }));
              }} placeholder={f.ph} style={{ width: "100%", padding: "13px 14px", borderRadius: 12, border: "2px solid #e8edf2", fontSize: 15, boxSizing: "border-box", outline: "none", transition: "border 0.2s, box-shadow 0.2s" }} onFocus={e => { e.target.style.borderColor = config.primaryColor; e.target.style.boxShadow = `0 0 0 3px ${config.primaryColor}18`; }} onBlur={e => { e.target.style.borderColor = "#e8edf2"; e.target.style.boxShadow = "none"; }} />
            </div>
          ))}

          <label style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: 14, background: "#f8fafc", borderRadius: 12, marginBottom: 20, cursor: "pointer", border: regForm.agree ? `2px solid ${config.primaryColor}30` : "2px solid transparent" }}>
            <input type="checkbox" checked={regForm.agree} onChange={e => setRegForm(p => ({ ...p, agree: e.target.checked }))} style={{ marginTop: 2, width: 20, height: 20, accentColor: config.primaryColor, flexShrink: 0 }} />
            <span style={{ fontSize: 11, color: "#64748b", lineHeight: 1.6 }}><strong style={{ color: config.primaryColor }}>[í•„ìˆ˜]</strong> ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.<br />ìˆ˜ì§‘í•­ëª©: ì´ë¦„, ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬, íœ´ëŒ€í°ë²ˆí˜¸<br />ëª©ì : ìŠ¤íƒ¬í”„ íˆ¬ì–´ ì°¸ì—¬ ë° ê²½í’ˆ ì§€ê¸‰<br />ë³´ìœ ê¸°ê°„: í–‰ì‚¬ ì¢…ë£Œ í›„ 1ê°œì›” ì´ë‚´ íŒŒê¸°</span>
          </label>

          <button onClick={handleRegister} disabled={!regForm.name || regForm.birth.length < 6 || regForm.phone.length < 12 || !regForm.agree} style={{ width: "100%", padding: 15, borderRadius: 14, border: "none", background: (regForm.name && regForm.birth.length >= 6 && regForm.phone.length >= 12 && regForm.agree) ? `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})` : "#cbd5e1", color: "#fff", fontSize: 17, fontWeight: 800, cursor: (regForm.name && regForm.birth.length >= 6 && regForm.phone.length >= 12 && regForm.agree) ? "pointer" : "not-allowed", transition: "all 0.3s", boxShadow: (regForm.name && regForm.birth.length >= 6 && regForm.phone.length >= 12 && regForm.agree) ? `0 6px 24px ${config.primaryColor}44` : "none", fontFamily: config.titleFont, letterSpacing: 1 }}>
            ğŸš€ íˆ¬ì–´ ì‹œì‘í•˜ê¸°
          </button>
        </div>
      )}

      <p style={{ color: "rgba(255,255,255,0.5)", fontSize: 10, marginTop: 20 }}>Â© 2026 ëŒ€ì „ê´‘ì—­ì‹œ</p>
      <style>{`
        @keyframes floatDown { 0% { transform: translateY(-10vh) rotate(0deg); opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateY(110vh) rotate(360deg); opacity:0; } }
        @keyframes heroFloat { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes bounceIn { 0% { transform:scale(0.3);opacity:0 } 50% { transform:scale(1.05) } 70% { transform:scale(0.95) } 100% { transform:scale(1);opacity:1 } }
        @keyframes toastIn { from { transform: translateX(-50%) translateY(-20px); opacity:0; } to { transform: translateX(-50%) translateY(0); opacity:1; } }
        @keyframes twinkle { 0%,100% { opacity: 0.15; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.4); } }
        @keyframes shootStar { 0% { left: -20%; opacity: 0; } 5% { opacity: 1; } 30% { left: 120%; opacity: 0; } 100% { left: 120%; opacity: 0; } }
        @keyframes nebulaPulse { 0%,100% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }
        @keyframes orbitSpin { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(360deg); } }
        @keyframes electronFloat { 0%,100% { transform: translateY(0) translateX(0); } 25% { transform: translateY(-15px) translateX(10px); } 50% { transform: translateY(-5px) translateX(-8px); } 75% { transform: translateY(-20px) translateX(5px); } }
        @keyframes helixWave { 0%,100% { transform: translateY(0); opacity: 0.25; } 50% { transform: translateY(-8px); opacity: 0.5; } }
        @keyframes circuitPulse { 0%,100% { opacity: 0.15; box-shadow: 0 0 4px rgba(0,255,200,0.1); } 50% { opacity: 0.6; box-shadow: 0 0 12px rgba(0,255,200,0.4); } }
        @keyframes dataFlowV { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 0.7; } 90% { opacity: 0.7; } 100% { transform: translateY(60vh); opacity: 0; } }
        @keyframes dataFlowH { 0% { transform: translateX(0); opacity: 0; } 10% { opacity: 0.7; } 90% { opacity: 0.7; } 100% { transform: translateX(50vw); opacity: 0; } }
        @keyframes rocketStar { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-120vh); opacity: 0; } }
        @keyframes bubbleUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 10% { opacity: 1; } 80% { opacity: 0.6; } 100% { transform: translateY(-110vh) scale(1.2); opacity: 0; } }
      `}</style>
    </div>
  );

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â–ˆâ–ˆ ADMIN PANEL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  if (screen === "admin" && adminAuth) return (
    <div style={{ ...css, background: "#f1f5f9", minHeight: "100vh" }}>
      <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700;900&family=Jua&family=Do+Hyeon&family=Gugi&family=Gaegu&family=Gamja+Flower&family=Gothic+A1:wght@400;700&display=swap" rel="stylesheet" />
      <ToastNotification />

      {/* Header */}
      <div style={{ background: "#1e293b", color: "#fff", padding: "14px 18px", display: "flex", alignItems: "center", justifyContent: "space-between", position: "sticky", top: 0, zIndex: 100 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ fontSize: 18 }}>âš™ï¸</span><span style={{ fontWeight: 800, fontSize: 15 }}>ê´€ë¦¬ì ëª¨ë“œ</span></div>
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={() => showToast("âœ… ëª¨ë“  ì„¤ì •ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤!")} style={{ background: "#059669", border: "none", color: "#fff", padding: "7px 14px", borderRadius: 8, cursor: "pointer", fontSize: 12, fontWeight: 700 }}>ğŸ’¾ ì €ì¥í™•ì¸</button>
          <button onClick={() => { setScreen(user ? "tour" : "register"); }} style={{ background: "rgba(255,255,255,0.12)", border: "none", color: "#fff", padding: "7px 14px", borderRadius: 8, cursor: "pointer", fontSize: 12, fontWeight: 600 }}>âœ• ë‚˜ê°€ê¸°</button>
        </div>
      </div>

      {/* Tabs */}
      <div style={{ display: "flex", overflowX: "auto", background: "#fff", borderBottom: "2px solid #f1f5f9", position: "sticky", top: 49, zIndex: 99 }}>
        {[{ id: "locations", icon: "ğŸ“", label: "ì¥ì†Œ" }, { id: "design", icon: "ğŸ¨", label: "ë””ìì¸" }, { id: "qrcodes", icon: "ğŸ“±", label: "QRì½”ë“œ" }, { id: "festival", icon: "ğŸ“‹", label: "ì¶•ì œì •ë³´" }, { id: "users", icon: "ğŸ‘¥", label: "ì°¸ê°€ì" }, { id: "deploy", icon: "ğŸ“¤", label: "ë°°í¬" }].map(t => (
          <button key={t.id} onClick={() => setAdminTab(t.id)} style={{ padding: "11px 14px", border: "none", borderBottom: adminTab === t.id ? `3px solid ${config.primaryColor}` : "3px solid transparent", background: "transparent", color: adminTab === t.id ? config.primaryColor : "#94a3b8", fontWeight: adminTab === t.id ? 700 : 400, fontSize: 12, cursor: "pointer", whiteSpace: "nowrap" }}>{t.icon} {t.label}</button>
        ))}
      </div>

      <div style={{ padding: 16, maxWidth: 600, margin: "0 auto" }}>
        {/* Auto-save indicator */}
        <div style={{ background: "#ecfdf5", borderRadius: 10, padding: "10px 14px", marginBottom: 14, display: "flex", alignItems: "center", gap: 8, fontSize: 12, color: "#065f46" }}>
          <span style={{ width: 8, height: 8, borderRadius: "50%", background: "#10b981", display: "inline-block", animation: "pulse 2s infinite" }} />
          <span>ìë™ ì €ì¥ í™œì„±í™” â€” ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì¦‰ì‹œ ì €ì¥ë©ë‹ˆë‹¤</span>
        </div>

        {/* â”€â”€â”€ LOCATIONS â”€â”€â”€ */}
        {adminTab === "locations" && (<div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
            <h3 style={{ fontSize: 15, fontWeight: 800, margin: 0 }}>ìŠ¤íƒ¬í”„ ì¥ì†Œ ({config.locations.length}ê°œ)</h3>
            <button onClick={() => { const nl = { id: `loc${Date.now()}`, name: "ìƒˆ ì¥ì†Œ", icon: "ğŸ“", code: `DJSF2026-${String.fromCharCode(65 + config.locations.length)}${config.locations.length + 1}`, mission: "ë¯¸ì…˜ ë‚´ìš© ì…ë ¥", desc: "ì¥ì†Œ ì„¤ëª… ì…ë ¥", iconImage: null }; saveConfig({ ...config, locations: [...config.locations, nl] }); setEditLoc(nl.id); }} style={{ background: config.primaryColor, color: "#fff", border: "none", padding: "8px 14px", borderRadius: 8, fontSize: 12, fontWeight: 700, cursor: "pointer" }}>+ ì¥ì†Œ ì¶”ê°€</button>
          </div>
          {config.locations.map((loc, idx) => (
            <div key={loc.id} style={{ background: "#fff", borderRadius: 14, padding: 16, marginBottom: 10, boxShadow: "0 1px 3px rgba(0,0,0,0.05)", border: editLoc === loc.id ? `2px solid ${config.primaryColor}` : "1px solid #f1f5f9" }}>
              {editLoc === loc.id ? (<div>
                <div style={{ marginBottom: 12 }}>
                  <label style={{ fontSize: 11, fontWeight: 700, color: "#64748b", display: "block", marginBottom: 6 }}>ì•„ì´ì½˜</label>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
                    {loc.iconImage ? <img src={loc.iconImage} alt="" style={{ width: 40, height: 40, borderRadius: 10, objectFit: "cover" }} /> : <span style={{ fontSize: 32 }}>{loc.icon}</span>}
                    <button onClick={() => setShowEmojiPicker(showEmojiPicker === loc.id ? null : loc.id)} style={{ padding: "6px 10px", borderRadius: 8, border: "1px solid #e2e8f0", background: "#f8fafc", fontSize: 11, cursor: "pointer" }}>ì´ëª¨ì§€ ë³€ê²½</button>
                    <button onClick={() => handleImageUpload((img) => { const u = config.locations.map(l => l.id === loc.id ? { ...l, iconImage: img } : l); saveConfig({ ...config, locations: u }); }, 200)} style={{ padding: "6px 10px", borderRadius: 8, border: "1px solid #e2e8f0", background: "#f8fafc", fontSize: 11, cursor: "pointer" }}>ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                    {loc.iconImage && <button onClick={() => { const u = config.locations.map(l => l.id === loc.id ? { ...l, iconImage: null } : l); saveConfig({ ...config, locations: u }); }} style={{ padding: "6px 8px", borderRadius: 8, border: "1px solid #fecaca", background: "#fef2f2", fontSize: 11, cursor: "pointer", color: "#dc2626" }}>âœ•</button>}
                  </div>
                  {showEmojiPicker === loc.id && (
                    <div style={{ display: "flex", flexWrap: "wrap", gap: 4, marginTop: 8, padding: 8, background: "#f8fafc", borderRadius: 10, maxHeight: 120, overflowY: "auto" }}>
                      {EMOJI_LIST.map(em => <button key={em} onClick={() => { const u = config.locations.map(l => l.id === loc.id ? { ...l, icon: em, iconImage: null } : l); saveConfig({ ...config, locations: u }); setShowEmojiPicker(null); }} style={{ width: 36, height: 36, border: loc.icon === em ? `2px solid ${config.primaryColor}` : "1px solid #e2e8f0", borderRadius: 8, background: "#fff", fontSize: 18, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" }}>{em}</button>)}
                    </div>
                  )}
                </div>
                {[{ k: "name", l: "ì¥ì†Œëª…", t: "input" }, { k: "code", l: "QR ì½”ë“œê°’ (ê³ ìœ  ì½”ë“œ)", t: "input", mono: true }, { k: "mission", l: "ë¯¸ì…˜ ë‚´ìš©", t: "textarea" }, { k: "desc", l: "ì¥ì†Œ ì„¤ëª…", t: "textarea" }].map(f => (
                  <div key={f.k} style={{ marginBottom: 10 }}>
                    <label style={{ fontSize: 11, fontWeight: 700, color: "#64748b" }}>{f.l}</label>
                    {f.t === "textarea" ? (
                      <textarea value={loc[f.k]} onChange={e => { const u = config.locations.map(l => l.id === loc.id ? { ...l, [f.k]: e.target.value } : l); saveConfig({ ...config, locations: u }); }} rows={2} style={{ width: "100%", padding: 10, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 13, boxSizing: "border-box", resize: "vertical" }} />
                    ) : (
                      <input value={loc[f.k]} onChange={e => { const v = f.k === "code" ? e.target.value.toUpperCase() : e.target.value; const u = config.locations.map(l => l.id === loc.id ? { ...l, [f.k]: v } : l); saveConfig({ ...config, locations: u }); }} style={{ width: "100%", padding: 10, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 13, boxSizing: "border-box", fontFamily: f.mono ? "monospace" : "inherit" }} />
                    )}
                  </div>
                ))}
                <button onClick={() => { setEditLoc(null); setShowEmojiPicker(null); showToast("âœ… ì¥ì†Œ ìˆ˜ì • ì €ì¥ ì™„ë£Œ!"); }} style={{ background: config.primaryColor, color: "#fff", border: "none", padding: "9px 24px", borderRadius: 8, fontSize: 13, fontWeight: 700, cursor: "pointer" }}>âœ“ í¸ì§‘ ì™„ë£Œ</button>
              </div>) : (
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <div style={{ display: "flex", gap: 12, alignItems: "center" }}>
                    {loc.iconImage ? <img src={loc.iconImage} alt="" style={{ width: 36, height: 36, borderRadius: 8, objectFit: "cover" }} /> : <span style={{ fontSize: 26 }}>{loc.icon}</span>}
                    <div>
                      <div style={{ fontWeight: 700, fontSize: 14 }}>{loc.name}</div>
                      <div style={{ fontSize: 10, color: "#94a3b8", fontFamily: "monospace" }}>{loc.code}</div>
                    </div>
                  </div>
                  <div style={{ display: "flex", gap: 6 }}>
                    <button onClick={() => setEditLoc(loc.id)} style={{ background: "#f1f5f9", border: "none", padding: "6px 10px", borderRadius: 6, fontSize: 12, cursor: "pointer" }}>âœï¸</button>
                    <button onClick={() => { if (config.locations.length <= 1) return; saveConfig({ ...config, locations: config.locations.filter(l => l.id !== loc.id) }); }} style={{ background: "#fef2f2", border: "none", padding: "6px 10px", borderRadius: 6, fontSize: 12, cursor: "pointer" }}>ğŸ—‘</button>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>)}

        {/* â”€â”€â”€ DESIGN â”€â”€â”€ */}
        {adminTab === "design" && (<div>
          <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 14 }}>ğŸ¨ ë””ìì¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•</h3>

          {/* Background Theme */}
          <div style={{ background: "#fff", borderRadius: 14, padding: 16, marginBottom: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: "#334155" }}>ğŸŒŒ ë°°ê²½ ìŠ¤í‚¨</h4>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
              {BG_THEMES.map(t => (
                <button key={t.id} onClick={() => saveConfig({ ...config, bgTheme: t.id })} style={{
                  padding: "12px 10px", borderRadius: 12, cursor: "pointer", textAlign: "left",
                  border: config.bgTheme === t.id ? `2px solid ${config.primaryColor}` : "2px solid #e2e8f0",
                  background: config.bgTheme === t.id ? `${config.primaryColor}08` : "#f8fafc",
                  transition: "all 0.2s"
                }}>
                  <div style={{ fontSize: 22, marginBottom: 4 }}>{t.icon}</div>
                  <div style={{ fontSize: 12, fontWeight: 700, color: config.bgTheme === t.id ? config.primaryColor : "#334155" }}>{t.name}</div>
                  <div style={{ fontSize: 10, color: "#94a3b8", marginTop: 2 }}>{t.desc}</div>
                </button>
              ))}
            </div>
          </div>

          <div style={{ background: "#fff", borderRadius: 14, padding: 16, marginBottom: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 14, color: "#334155" }}>ğŸ–¼ ì´ë¯¸ì§€ ê´€ë¦¬</h4>
            {[
              { key: "heroImage", label: "ì‹œì‘í™”ë©´ ìºë¦­í„°", desc: "PNG ê¶Œì¥ (íˆ¬ëª…ë°°ê²½)", preview: 100 },
              { key: "stampImage", label: "ì™„ë£Œ ìŠ¤íƒ¬í”„ ì´ë¯¸ì§€", desc: "ìˆ˜ì§‘ì™„ë£Œ ì‹œ í‘œì‹œ", preview: 60 },
              { key: "stampEmptyImage", label: "ë¯¸ì™„ë£Œ ìŠ¤íƒ¬í”„ ì´ë¯¸ì§€", desc: "ë¯¸ìˆ˜ì§‘ ì‹œ í‘œì‹œ", preview: 60 },
              { key: "aiCharImage", label: "AI ì•ˆë‚´ ë§¤ë‹ˆì € ìºë¦­í„°", desc: "ì±„íŒ… ì•„ë°”íƒ€ ì´ë¯¸ì§€ (ì •ì‚¬ê°í˜• ê¶Œì¥)", preview: 60 },
              { key: "mapImage", label: "ì „ì²´ ì•ˆë‚´ ì§€ë„", desc: "ì¥ì†Œ ìœ„ì¹˜ê°€ í‘œì‹œëœ ì§€ë„", preview: 140 },
            ].map(item => (
              <div key={item.key} style={{ display: "flex", alignItems: "center", gap: 12, padding: "12px 0", borderBottom: "1px solid #f1f5f9" }}>
                <div style={{ width: item.preview > 80 ? 80 : 56, height: item.preview > 80 ? 60 : 56, borderRadius: 10, background: "#f8fafc", display: "flex", alignItems: "center", justifyContent: "center", overflow: "hidden", border: "2px dashed #e2e8f0", flexShrink: 0 }}>
                  {config[item.key] ? <img src={config[item.key]} alt="" style={{ width: "100%", height: "100%", objectFit: "cover" }} /> : <span style={{ fontSize: 10, color: "#94a3b8" }}>ì—†ìŒ</span>}
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 13, fontWeight: 600, color: "#334155" }}>{item.label}</div>
                  <div style={{ fontSize: 10, color: "#94a3b8" }}>{item.desc}</div>
                </div>
                <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                  <button onClick={() => handleImageUpload((img) => saveConfig({ ...config, [item.key]: img }), item.key === "mapImage" ? 1200 : 400)} style={{ padding: "5px 10px", borderRadius: 6, border: "1px solid #e2e8f0", background: "#f8fafc", fontSize: 10, cursor: "pointer" }}>ğŸ“· ì—…ë¡œë“œ</button>
                  {config[item.key] && <button onClick={() => saveConfig({ ...config, [item.key]: null })} style={{ padding: "5px 10px", borderRadius: 6, border: "1px solid #fecaca", background: "#fef2f2", fontSize: 10, cursor: "pointer", color: "#dc2626" }}>ì‚­ì œ</button>}
                </div>
              </div>
            ))}
          </div>

          <div style={{ background: "#fff", borderRadius: 14, padding: 16, marginBottom: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: "#334155" }}>âœï¸ í…ìŠ¤íŠ¸</h4>
            {[{ k: "festivalName", l: "ì¶•ì œëª…" }, { k: "subtitle", l: "ë¶€ì œëª©" }].map(f => (
              <div key={f.k} style={{ marginBottom: 10 }}>
                <label style={{ fontSize: 11, fontWeight: 600, color: "#64748b" }}>{f.l}</label>
                <input value={config[f.k]} onChange={e => saveConfig({ ...config, [f.k]: e.target.value })} style={{ width: "100%", padding: 10, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 14, boxSizing: "border-box" }} />
              </div>
            ))}
            <div style={{ marginBottom: 6 }}>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#64748b" }}>ì™„ë£Œ ë©”ì‹œì§€</label>
              <textarea value={config.completionMessage} onChange={e => saveConfig({ ...config, completionMessage: e.target.value })} rows={3} style={{ width: "100%", padding: 10, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 13, boxSizing: "border-box", resize: "vertical" }} />
            </div>
          </div>

          <div style={{ background: "#fff", borderRadius: 14, padding: 16, marginBottom: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: "#334155" }}>ğŸ¨ ìƒ‰ìƒ</h4>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
              {[{ k: "primaryColor", l: "ë©”ì¸" }, { k: "secondaryColor", l: "ë³´ì¡°" }, { k: "accentColor", l: "ê°•ì¡°" }, { k: "bgColor", l: "ë°°ê²½" }, { k: "textColor", l: "ê¸€ì" }, { k: "cardBg", l: "ì¹´ë“œ" }].map(c => (
                <div key={c.k}>
                  <label style={{ fontSize: 10, fontWeight: 600, color: "#64748b" }}>{c.l}</label>
                  <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                    <input type="color" value={config[c.k]} onChange={e => saveConfig({ ...config, [c.k]: e.target.value })} style={{ width: 32, height: 32, border: "2px solid #e2e8f0", borderRadius: 8, cursor: "pointer", padding: 0 }} />
                    <input value={config[c.k]} onChange={e => saveConfig({ ...config, [c.k]: e.target.value })} style={{ flex: 1, padding: 7, borderRadius: 6, border: "1px solid #e2e8f0", fontSize: 11, fontFamily: "monospace" }} />
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div style={{ background: "#fff", borderRadius: 14, padding: 16, marginBottom: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: "#334155" }}>ğŸ”¤ í°íŠ¸</h4>
            {[{ k: "titleFont", l: "ì œëª©", opts: ["'Black Han Sans',sans-serif", "'Jua',sans-serif", "'Do Hyeon',sans-serif", "'Gugi',sans-serif", "'Gaegu',cursive"] }, { k: "fontFamily", l: "ë³¸ë¬¸", opts: ["'Noto Sans KR',sans-serif", "'Jua',sans-serif", "'Gothic+A1',sans-serif", "'Gamja Flower',cursive", "'Gaegu',cursive"] }].map(f => (
              <div key={f.k} style={{ marginBottom: 10 }}>
                <label style={{ fontSize: 10, fontWeight: 600, color: "#64748b" }}>{f.l}</label>
                <select value={config[f.k]} onChange={e => saveConfig({ ...config, [f.k]: e.target.value })} style={{ width: "100%", padding: 10, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 13 }}>
                  {f.opts.map(o => <option key={o} value={o}>{o.split("'")[1]}</option>)}
                </select>
                <div style={{ marginTop: 4, padding: 8, background: "#f8fafc", borderRadius: 8, fontFamily: config[f.k], fontSize: f.k === "titleFont" ? 20 : 14 }}>ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸</div>
              </div>
            ))}
          </div>

          <div style={{ background: "#fff", borderRadius: 14, padding: 16, boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: "#334155" }}>ğŸ‘ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</h4>
            <div style={{ background: `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})`, borderRadius: 14, padding: 20, textAlign: "center" }}>
              {config.heroImage && <img src={config.heroImage} alt="" style={{ width: 60, height: 60, objectFit: "contain", marginBottom: 6 }} />}
              <div style={{ fontFamily: config.titleFont, fontSize: 16, color: "#fff" }}>{config.festivalName}</div>
              <div style={{ fontFamily: config.fontFamily, fontSize: 11, color: "rgba(255,255,255,0.8)", marginTop: 3 }}>{config.subtitle}</div>
              <div style={{ display: "flex", justifyContent: "center", gap: 6, marginTop: 12 }}>
                {config.locations.slice(0, 6).map((l, i) => (
                  <div key={i} style={{ width: 30, height: 30, borderRadius: "50%", background: i < 3 ? config.accentColor : "rgba(255,255,255,0.25)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: i < 3 ? 12 : 10, color: "#fff" }}>{i < 3 ? "âœ“" : l.icon}</div>
                ))}
              </div>
            </div>
          </div>
        </div>)}

        {/* â”€â”€â”€ QR CODES â”€â”€â”€ */}
        {adminTab === "qrcodes" && (<div>
          <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 6 }}>ğŸ“± QR ì½”ë“œ ê´€ë¦¬</h3>
          <p style={{ fontSize: 12, color: "#64748b", marginBottom: 16 }}>ê° ì¥ì†Œì— ì•„ë˜ QR ì½”ë“œë¥¼ ì¸ì‡„í•˜ì—¬ ë¹„ì¹˜í•´ì£¼ì„¸ìš”. QR ì½”ë“œë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            {config.locations.map(loc => (
              <div key={loc.id} style={{ background: "#fff", borderRadius: 14, padding: 14, textAlign: "center", boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
                <div style={{ fontSize: 22, marginBottom: 4 }}>{loc.icon}</div>
                <div style={{ fontSize: 12, fontWeight: 700, color: "#334155", marginBottom: 6 }}>{loc.name}</div>
                <img src={getQRUrl(loc.code, 300)} alt={loc.code} style={{ width: "100%", maxWidth: 160, borderRadius: 8, border: "1px solid #f1f5f9" }} />
                <div style={{ marginTop: 6, fontSize: 9, color: "#94a3b8", fontFamily: "monospace", background: "#f8fafc", padding: "3px 6px", borderRadius: 4 }}>{loc.code}</div>
              </div>
            ))}
          </div>
        </div>)}

        {/* â”€â”€â”€ FESTIVAL INFO + API KEY â”€â”€â”€ */}
        {adminTab === "festival" && (<div>
          <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 6 }}>ğŸ“‹ ì¶•ì œ ì •ë³´ (AI ë§¤ë‹ˆì €ìš©)</h3>
          <p style={{ fontSize: 12, color: "#64748b", marginBottom: 14 }}>ì—¬ê¸° ì…ë ¥í•œ ì •ë³´ë¥¼ AI ë§¤ë‹ˆì €ê°€ í•™ìŠµí•˜ì—¬ ê´€ëŒê° ì§ˆë¬¸ì— ë‹µë³€í•©ë‹ˆë‹¤.</p>
          <textarea value={config.festivalInfo} onChange={e => saveConfig({ ...config, festivalInfo: e.target.value })} rows={14} style={{ width: "100%", padding: 14, borderRadius: 12, border: "2px solid #e2e8f0", fontSize: 14, lineHeight: 1.8, boxSizing: "border-box", resize: "vertical" }} placeholder="ì¶•ì œ ì •ë³´ë¥¼ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”..." />
          <div style={{ marginTop: 10, padding: 12, background: "#ecfdf5", borderRadius: 10, fontSize: 11, color: "#065f46" }}>ğŸ’¡ ì¶•ì œ ì¼ì •, ìš´ì˜ì‹œê°„, ì£¼ì°¨ì •ë³´, í”„ë¡œê·¸ë¨, ë§›ì§‘, í¸ì˜ì‹œì„¤ ë“±ì„ ìƒì„¸íˆ ì‘ì„±í•˜ë©´ AI ë‹µë³€ í’ˆì§ˆì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</div>

          {/* FAQ Management */}
          <div style={{ marginTop: 20, background: "#fff", borderRadius: 14, padding: 16, boxShadow: "0 1px 3px rgba(0,0,0,0.05)", border: "2px solid #fef3c7" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <h4 style={{ fontSize: 13, fontWeight: 700, color: "#92400e", display: "flex", alignItems: "center", gap: 6 }}>ğŸ’¬ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)</h4>
              <button onClick={() => { const faq = [...(config.faqList || []), { keywords: "", answer: "" }]; saveConfig({ ...config, faqList: faq }); }} style={{ background: "#f59e0b", border: "none", color: "#fff", padding: "5px 12px", borderRadius: 8, fontSize: 11, fontWeight: 700, cursor: "pointer" }}>+ ì¶”ê°€</button>
            </div>
            <p style={{ fontSize: 11, color: "#78716c", marginBottom: 12, lineHeight: 1.5 }}>í‚¤ì›Œë“œë¥¼ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”. ê´€ëŒê° ì§ˆë¬¸ì— í‚¤ì›Œë“œê°€ í¬í•¨ë˜ë©´ í•´ë‹¹ ë‹µë³€ì´ ìë™ ì¶œë ¥ë©ë‹ˆë‹¤.<br />API í‚¤ ì—†ì´ë„ ì‘ë™í•©ë‹ˆë‹¤!</p>
            {(config.faqList || []).map((faq, idx) => (
              <div key={idx} style={{ background: "#fffbeb", borderRadius: 10, padding: 12, marginBottom: 8, border: "1px solid #fef3c7" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                  <span style={{ fontSize: 11, fontWeight: 700, color: "#92400e" }}>FAQ #{idx + 1}</span>
                  <button onClick={() => { const faq = config.faqList.filter((_, i) => i !== idx); saveConfig({ ...config, faqList: faq }); }} style={{ background: "#fef2f2", border: "none", padding: "3px 8px", borderRadius: 6, fontSize: 10, cursor: "pointer", color: "#dc2626" }}>ì‚­ì œ</button>
                </div>
                <div style={{ marginBottom: 6 }}>
                  <label style={{ fontSize: 10, color: "#64748b" }}>í‚¤ì›Œë“œ (ì‰¼í‘œ êµ¬ë¶„)</label>
                  <input value={faq.keywords} onChange={e => { const f = [...config.faqList]; f[idx] = { ...f[idx], keywords: e.target.value }; saveConfig({ ...config, faqList: f }); }} placeholder="ì£¼ì°¨, ì£¼ì°¨ì¥, íŒŒí‚¹" style={{ width: "100%", padding: 8, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 12, boxSizing: "border-box", fontFamily: "monospace" }} />
                </div>
                <div>
                  <label style={{ fontSize: 10, color: "#64748b" }}>ë‹µë³€</label>
                  <textarea value={faq.answer} onChange={e => { const f = [...config.faqList]; f[idx] = { ...f[idx], answer: e.target.value }; saveConfig({ ...config, faqList: f }); }} rows={2} placeholder="ê´€ëŒê°ì—ê²Œ ë³´ì—¬ì¤„ ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" style={{ width: "100%", padding: 8, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 12, boxSizing: "border-box", resize: "vertical", lineHeight: 1.5 }} />
                </div>
              </div>
            ))}
            {(!config.faqList || config.faqList.length === 0) && <div style={{ textAlign: "center", padding: 20, color: "#94a3b8", fontSize: 12 }}>ë“±ë¡ëœ FAQê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ + ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë“±ë¡í•˜ì„¸ìš”.</div>}
          </div>

          {/* Shortcut Links */}
          <div style={{ marginTop: 20, background: "#fff", borderRadius: 14, padding: 16, boxShadow: "0 1px 3px rgba(0,0,0,0.05)", border: "2px solid #e0f2fe" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: "#0369a1", display: "flex", alignItems: "center", gap: 6 }}>ğŸ”— ë°”ë¡œê°€ê¸° ë§í¬ (í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜)</h4>
            {[
              { key: "linkHome", title: "ì¶•ì œ í™ˆí˜ì´ì§€", defaultIcon: "ğŸŒ" },
              { key: "linkSns", title: "ì¶•ì œ SNS", defaultIcon: "ğŸ“¸" },
            ].map(item => {
              const link = config[item.key] || { icon: item.defaultIcon, label: item.title, url: "" };
              return (
                <div key={item.key} style={{ padding: 14, background: "#f8fafc", borderRadius: 12, marginBottom: 10 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: "#334155", marginBottom: 10 }}>{item.title}</div>
                  <div style={{ display: "flex", gap: 8, marginBottom: 8 }}>
                    <div style={{ width: 70 }}>
                      <label style={{ fontSize: 10, color: "#64748b" }}>ì•„ì´ì½˜</label>
                      <input value={link.icon} onChange={e => saveConfig({ ...config, [item.key]: { ...link, icon: e.target.value } })} style={{ width: "100%", padding: 8, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 18, textAlign: "center", boxSizing: "border-box" }} maxLength={2} />
                    </div>
                    <div style={{ flex: 1 }}>
                      <label style={{ fontSize: 10, color: "#64748b" }}>ë²„íŠ¼ ì´ë¦„</label>
                      <input value={link.label} onChange={e => saveConfig({ ...config, [item.key]: { ...link, label: e.target.value } })} placeholder="í™ˆí˜ì´ì§€" style={{ width: "100%", padding: 8, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 13, boxSizing: "border-box" }} />
                    </div>
                  </div>
                  <div>
                    <label style={{ fontSize: 10, color: "#64748b" }}>URL ì£¼ì†Œ</label>
                    <input value={link.url} onChange={e => saveConfig({ ...config, [item.key]: { ...link, url: e.target.value } })} placeholder="https://" style={{ width: "100%", padding: 8, borderRadius: 8, border: "1px solid #e2e8f0", fontSize: 13, boxSizing: "border-box", fontFamily: "monospace" }} />
                  </div>
                  <div style={{ marginTop: 6, display: "flex", alignItems: "center", gap: 6 }}>
                    <div style={{ width: 6, height: 6, borderRadius: "50%", background: link.url ? "#10b981" : "#94a3b8" }} />
                    <span style={{ fontSize: 10, color: link.url ? "#065f46" : "#94a3b8" }}>{link.url ? "ì„¤ì •ë¨ â€” í•˜ë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤" : "ë¯¸ì„¤ì • â€” URL ì…ë ¥ ì‹œ í•˜ë‹¨ì— í‘œì‹œ"}</span>
                  </div>
                </div>
              );
            })}
          </div>

          {/* API Key section */}
          <div style={{ marginTop: 20, background: "#fff", borderRadius: 14, padding: 16, boxShadow: "0 1px 3px rgba(0,0,0,0.05)", border: "2px solid #fef3c7" }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, marginBottom: 8, color: "#92400e", display: "flex", alignItems: "center", gap: 6 }}>ğŸ”‘ AI ê¸°ëŠ¥ ì„¤ì • (ì™¸ë¶€ í˜¸ìŠ¤íŒ…ìš©)</h4>
            <p style={{ fontSize: 11, color: "#78716c", lineHeight: 1.6, marginBottom: 12 }}>
              ì›¹í˜¸ìŠ¤íŒ…ì— ì—…ë¡œë“œí•˜ì—¬ ì‚¬ìš©í•  ê²½ìš°, AI ì±„íŒ… ê¸°ëŠ¥ì„ ìœ„í•´ Anthropic API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br />
              <strong>console.anthropic.com</strong>ì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div style={{ position: "relative" }}>
              <input
                type="password"
                value={config.apiKey || ""}
                onChange={e => saveConfig({ ...config, apiKey: e.target.value })}
                placeholder="sk-ant-api03-..."
                style={{ width: "100%", padding: "12px 14px", borderRadius: 10, border: "2px solid #e2e8f0", fontSize: 13, boxSizing: "border-box", fontFamily: "monospace" }}
              />
            </div>
            <div style={{ marginTop: 8, display: "flex", alignItems: "center", gap: 6 }}>
              <div style={{ width: 8, height: 8, borderRadius: "50%", background: config.apiKey ? "#10b981" : "#f59e0b" }} />
              <span style={{ fontSize: 11, color: config.apiKey ? "#065f46" : "#92400e" }}>
                {config.apiKey ? "API í‚¤ ì„¤ì •ë¨ â€” AI ì±„íŒ…ì´ í™œì„±í™”ë©ë‹ˆë‹¤" : "ë¯¸ì„¤ì • â€” Claude.ai ë‚´ì—ì„œëŠ” ìë™ ì‘ë™, ì™¸ë¶€ í˜¸ìŠ¤íŒ…ì—ì„œëŠ” í‚¤ í•„ìš”"}
              </span>
            </div>
          </div>
        </div>)}

        {/* â”€â”€â”€ PARTICIPANTS â”€â”€â”€ */}
        {adminTab === "users" && (<div>
          <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 14 }}>ğŸ‘¥ ì°¸ê°€ì ({participants.length}ëª…)</h3>
          {participants.length === 0 ? <div style={{ textAlign: "center", padding: 40, color: "#94a3b8" }}>ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div> : (
            <div style={{ background: "#fff", borderRadius: 12, overflow: "hidden", boxShadow: "0 1px 3px rgba(0,0,0,0.05)" }}>
              <div style={{ display: "grid", gridTemplateColumns: "40px 1fr 80px 1fr", padding: "10px 12px", background: "#f8fafc", fontSize: 10, fontWeight: 700, color: "#64748b" }}><div>#</div><div>ì´ë¦„</div><div>ìƒë…„ì›”ì¼</div><div>ì—°ë½ì²˜</div></div>
              {participants.slice().reverse().map((p, i) => (
                <div key={i} style={{ display: "grid", gridTemplateColumns: "40px 1fr 80px 1fr", padding: "10px 12px", borderTop: "1px solid #f1f5f9", fontSize: 12 }}>
                  <div style={{ color: "#94a3b8" }}>{participants.length - i}</div><div style={{ fontWeight: 600 }}>{p.name}</div><div>{p.birth}</div><div style={{ fontSize: 11 }}>{p.phone}</div>
                </div>
              ))}
            </div>
          )}
        </div>)}

        {/* â”€â”€â”€ DEPLOY â”€â”€â”€ */}
        {adminTab === "deploy" && (<div>
          <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 6 }}>ğŸ“¤ ë°°í¬ìš© íŒŒì¼ ë‚´ë³´ë‚´ê¸°</h3>
          <p style={{ fontSize: 12, color: "#64748b", marginBottom: 14, lineHeight: 1.6 }}>í˜„ì¬ ì„¤ì •(ì´ë¯¸ì§€, ì¥ì†Œ, ë””ìì¸ ë“±)ì´ ëª¨ë‘ í¬í•¨ëœ HTML íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.<br />ì´ íŒŒì¼ì„ ì›¹í˜¸ìŠ¤íŒ…ì— ì—…ë¡œë“œí•˜ë©´ ëª¨ë“  ë°©ë¬¸ìê°€ ë™ì¼í•œ ì„¤ì •ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

          <div style={{ background: "#fff", borderRadius: 14, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.05)", marginBottom: 14 }}>
            <div style={{ marginBottom: 16 }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: "#334155", marginBottom: 10 }}>í˜„ì¬ ì„¤ì • ìš”ì•½</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                {[
                  { label: "ì¥ì†Œ ìˆ˜", val: `${config.locations.length}ê°œ` },
                  { label: "ë°°ê²½ í…Œë§ˆ", val: BG_THEMES.find(t => t.id === config.bgTheme)?.name || "ì—†ìŒ" },
                  { label: "ì´ë¯¸ì§€", val: `${[config.heroImage, config.stampImage, config.stampEmptyImage, config.mapImage, config.aiCharImage].filter(Boolean).length}ê°œ ì„¤ì •` },
                  { label: "AI í‚¤", val: config.apiKey ? "âœ… ì„¤ì •ë¨" : "âš ï¸ ë¯¸ì„¤ì •" },
                  { label: "í™ˆí˜ì´ì§€ ë§í¬", val: config.linkHome?.url ? "âœ…" : "â€”" },
                  { label: "SNS ë§í¬", val: config.linkSns?.url ? "âœ…" : "â€”" },
                ].map((item, i) => (
                  <div key={i} style={{ background: "#f8fafc", borderRadius: 8, padding: "8px 12px" }}>
                    <div style={{ fontSize: 10, color: "#94a3b8" }}>{item.label}</div>
                    <div style={{ fontSize: 13, fontWeight: 600, color: "#334155" }}>{item.val}</div>
                  </div>
                ))}
              </div>
            </div>

            <button onClick={() => {
              showToast("â³ íŒŒì¼ ìƒì„±ì¤‘...", "info");
              setTimeout(() => {
                try {
                  const exportConfig = JSON.stringify(config);
                  const html = `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>${config.festivalName} - ìŠ¤íƒ¬í”„ íˆ¬ì–´</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body,#root{width:100%;min-height:100vh;min-height:100dvh}
body{font-family:'Noto Sans KR',sans-serif;-webkit-font-smoothing:antialiased;overflow-x:hidden}
</style>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"><\/script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"><\/script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"><\/script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"><\/script>
<script>
window.EMBEDDED_CONFIG = ${exportConfig};
window.storage = {
  async get(key, shared) {
    const v = localStorage.getItem("st_" + key);
    if (v === null) throw new Error("not found");
    return { key, value: v, shared: !!shared };
  },
  async set(key, value, shared) {
    localStorage.setItem("st_" + key, value);
    return { key, value, shared: !!shared };
  },
  async delete(key, shared) {
    localStorage.removeItem("st_" + key);
    return { key, deleted: true, shared: !!shared };
  },
  async list(prefix, shared) {
    const keys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k.startsWith("st_" + (prefix || ""))) keys.push(k.slice(3));
    }
    return { keys, prefix, shared: !!shared };
  }
};
<\/script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
` + document.querySelector('script[type="text/babel"]').textContent + `
<\/script>
</body>
</html>`;
                  const blob = new Blob([html], { type: "text/html;charset=utf-8" });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = "stamp-tour.html";
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                  showToast("âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!");
                } catch (err) {
                  showToast("âŒ íŒŒì¼ ìƒì„± ì‹¤íŒ¨: " + err.message, "error");
                }
              }, 300);
            }} style={{ width: "100%", padding: 16, borderRadius: 14, border: "none", background: `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})`, color: "#fff", fontSize: 16, fontWeight: 800, cursor: "pointer", boxShadow: `0 6px 24px ${config.primaryColor}44`, letterSpacing: 1 }}>
              ğŸ“¤ ë°°í¬ìš© HTML ë‹¤ìš´ë¡œë“œ
            </button>
          </div>

          <div style={{ background: "#fffbeb", borderRadius: 12, padding: 14, border: "1px solid #fef3c7" }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: "#92400e", marginBottom: 8 }}>ğŸ’¡ ì‚¬ìš© ë°©ë²•</div>
            <div style={{ fontSize: 11, color: "#78716c", lineHeight: 1.8 }}>
              1. ìœ„ ë²„íŠ¼ìœ¼ë¡œ <strong>stamp-tour.html</strong> íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ<br />
              2. ì›¹í˜¸ìŠ¤íŒ… ì„œë²„ì— ì´ íŒŒì¼ì„ ì—…ë¡œë“œ<br />
              3. ëª¨ë“  ë°©ë¬¸ìê°€ ë™ì¼í•œ ì„¤ì •(ì´ë¯¸ì§€, ì¥ì†Œ, ë””ìì¸)ì„ ë³¼ ìˆ˜ ìˆìŒ<br />
              4. ì„¤ì •ì„ ë³€ê²½í•  ë•Œë§ˆë‹¤ ë‹¤ì‹œ ë‚´ë³´ë‚´ê¸° â†’ ì¬ì—…ë¡œë“œ
            </div>
          </div>

          <div style={{ background: "#f0fdf4", borderRadius: 12, padding: 14, marginTop: 10, border: "1px solid #dcfce7" }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: "#065f46", marginBottom: 6 }}>ğŸ“‹ í¬í•¨ë˜ëŠ” í•­ëª©</div>
            <div style={{ fontSize: 11, color: "#047857", lineHeight: 1.8 }}>
              âœ… ì¶•ì œëª…, ìƒ‰ìƒ, í°íŠ¸, ë°°ê²½ ìŠ¤í‚¨<br />
              âœ… ëª¨ë“  ì—…ë¡œë“œëœ ì´ë¯¸ì§€ (base64 ë‚´ì¥)<br />
              âœ… ì¥ì†Œ, QRì½”ë“œ, ë¯¸ì…˜ ì •ë³´<br />
              âœ… AI ì±„íŒ… API í‚¤<br />
              âœ… í™ˆí˜ì´ì§€/SNS ë°”ë¡œê°€ê¸° ë§í¬<br />
              âœ… ì™„ë£Œ ë©”ì‹œì§€
            </div>
          </div>
        </div>)}
      </div>

      <style>{`@keyframes pulse { 0%,100% { transform:scale(1);opacity:1 } 50% { transform:scale(1.02);opacity:0.7 } } @keyframes toastIn { from { transform: translateX(-50%) translateY(-20px); opacity:0; } to { transform: translateX(-50%) translateY(0); opacity:1; } }`}</style>
    </div>
  );

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â–ˆâ–ˆ MAIN TOUR SCREEN
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  return (
    <div style={{ ...css, background: config.bgColor, minHeight: "100vh", paddingBottom: 90, position: "relative" }}>
      <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700;900&family=Jua&family=Do+Hyeon&family=Gugi&family=Gaegu&family=Gamja+Flower&family=Gothic+A1:wght@400;700&display=swap" rel="stylesheet" />
      <ToastNotification />
      <AdminButton />
      {showAdmin && !adminAuth && <AdminPwModal />}

      {/* â”€â”€â”€ COMPLETION MODAL â”€â”€â”€ */}
      {showComplete && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.65)", zIndex: 1100, display: "flex", alignItems: "center", justifyContent: "center", padding: 20, backdropFilter: "blur(6px)" }} onClick={() => setShowComplete(false)}>
          <div onClick={e => e.stopPropagation()} style={{ background: "#fff", borderRadius: 24, padding: "36px 28px", width: "100%", maxWidth: 340, textAlign: "center", animation: "bounceIn 0.5s" }}>
            <div style={{ fontSize: 56, marginBottom: 8 }}>ğŸ†</div>
            <h2 style={{ fontFamily: config.titleFont, fontSize: 22, color: config.primaryColor, margin: "0 0 10px" }}>ë¯¸ì…˜ ì™„ë£Œ!</h2>
            <p style={{ fontSize: 14, color: "#475569", lineHeight: 1.8, whiteSpace: "pre-line" }}>{config.completionMessage}</p>
            <div style={{ marginTop: 16, padding: 14, background: `${config.primaryColor}0a`, borderRadius: 12, fontSize: 13, color: config.primaryColor, fontWeight: 600 }}>ğŸ“‹ {user?.name} | ğŸ“± {user?.phone}</div>
            <button onClick={() => setShowComplete(false)} style={{ marginTop: 18, padding: "12px 40px", borderRadius: 12, border: "none", background: config.accentColor, color: "#fff", fontSize: 15, fontWeight: 800, cursor: "pointer" }}>í™•ì¸</button>
          </div>
        </div>
      )}

      {/* â”€â”€â”€ QR SCANNER MODAL â”€â”€â”€ */}
      {(scanning || scanResult) && (
        <div style={{ position: "fixed", inset: 0, background: "#000", zIndex: 1100, display: "flex", flexDirection: "column" }}>
          <div style={{ padding: "14px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", background: "rgba(0,0,0,0.8)", zIndex: 10 }}>
            <span style={{ color: "#fff", fontSize: 15, fontWeight: 700 }}>ğŸ“· QR ìŠ¤ìº”</span>
            <button onClick={() => { stopScanner(); setScanResult(null); }} style={{ background: "rgba(255,255,255,0.15)", border: "none", color: "#fff", padding: "8px 16px", borderRadius: 8, cursor: "pointer", fontSize: 13 }}>âœ• ë‹«ê¸°</button>
          </div>

          {scanResult && (
            <div style={{ flex: 1, display: "flex", alignItems: "center", justifyContent: "center", padding: 30 }}>
              <div style={{ background: "#fff", borderRadius: 24, padding: "40px 28px", width: "100%", maxWidth: 340, textAlign: "center", animation: "bounceIn 0.4s" }}>
                <div style={{ fontSize: 56, marginBottom: 8 }}>{scanResult.icon}</div>
                <h3 style={{ fontSize: 18, fontWeight: 800, color: scanResult.success ? config.primaryColor : "#dc2626", margin: "0 0 8px" }}>{scanResult.success ? "ìŠ¤íƒ¬í”„ íšë“!" : "ì•Œë¦¼"}</h3>
                <p style={{ fontSize: 15, color: "#475569", lineHeight: 1.6 }}>{scanResult.msg}</p>
                <div style={{ display: "flex", gap: 10, marginTop: 20 }}>
                  <button onClick={() => { setScanResult(null); startScanner(); }} style={{ flex: 1, padding: 12, borderRadius: 10, border: "1px solid #e2e8f0", background: "#f8fafc", fontSize: 14, cursor: "pointer" }}>ê³„ì† ìŠ¤ìº”</button>
                  <button onClick={() => { setScanResult(null); }} style={{ flex: 1, padding: 12, borderRadius: 10, border: "none", background: config.primaryColor, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer" }}>ëŒì•„ê°€ê¸°</button>
                </div>
              </div>
            </div>
          )}

          {!scanResult && (
            <div style={{ flex: 1, position: "relative", display: "flex", alignItems: "center", justifyContent: "center" }}>
              <video ref={videoRef} style={{ width: "100%", height: "100%", objectFit: "cover" }} playsInline muted />
              <canvas ref={canvasRef} style={{ display: "none" }} />
              <div style={{ position: "absolute", inset: 0, display: "flex", alignItems: "center", justifyContent: "center" }}>
                <div style={{ width: 240, height: 240, position: "relative" }}>
                  {[[0, 0, "top", "left"], [0, 1, "top", "right"], [1, 0, "bottom", "left"], [1, 1, "bottom", "right"]].map(([r, c, v, h]) => (
                    <div key={`${r}${c}`} style={{ position: "absolute", [v]: -2, [h]: -2, width: 36, height: 36, borderColor: config.secondaryColor, borderStyle: "solid", borderWidth: 0, [`border${v.charAt(0).toUpperCase() + v.slice(1)}Width`]: 4, [`border${h.charAt(0).toUpperCase() + h.slice(1)}Width`]: 4, [`border${v.charAt(0).toUpperCase() + v.slice(1)}${h.charAt(0).toUpperCase() + h.slice(1)}Radius`]: 12 }} />
                  ))}
                  <div style={{ position: "absolute", left: 10, right: 10, height: 3, background: `linear-gradient(90deg, transparent, ${config.secondaryColor}, transparent)`, borderRadius: 2, animation: "scanLine 2s ease-in-out infinite" }} />
                </div>
              </div>
              {cameraError && (
                <div style={{ position: "absolute", inset: 0, display: "flex", alignItems: "center", justifyContent: "center", background: "rgba(0,0,0,0.9)", padding: 30 }}>
                  <div style={{ textAlign: "center", color: "#fff" }}>
                    <div style={{ fontSize: 48, marginBottom: 12 }}>ğŸ“·</div>
                    <p style={{ fontSize: 15, whiteSpace: "pre-line", lineHeight: 1.6 }}>{cameraError}</p>
                    <button onClick={startScanner} style={{ marginTop: 20, padding: "12px 30px", borderRadius: 10, border: "none", background: config.primaryColor, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer" }}>ë‹¤ì‹œ ì‹œë„</button>
                  </div>
                </div>
              )}
              <div style={{ position: "absolute", bottom: 30, left: 0, right: 0, textAlign: "center" }}>
                <p style={{ color: "rgba(255,255,255,0.8)", fontSize: 13, textShadow: "0 1px 4px rgba(0,0,0,0.5)" }}>QR ì½”ë“œë¥¼ ì‚¬ê°í˜• ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</p>
              </div>
            </div>
          )}
        </div>
      )}

      {/* â”€â”€â”€ MAP MODAL â”€â”€â”€ */}
      {showMap && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.65)", zIndex: 1050, display: "flex", alignItems: "center", justifyContent: "center", padding: 16, backdropFilter: "blur(4px)" }} onClick={() => setShowMap(false)}>
          <div onClick={e => e.stopPropagation()} style={{ background: "#fff", borderRadius: 20, width: "100%", maxWidth: 420, maxHeight: "90vh", overflow: "hidden", display: "flex", flexDirection: "column", animation: "slideUp 0.3s" }}>
            <div style={{ padding: "14px 18px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: "1px solid #f1f5f9" }}>
              <span style={{ fontWeight: 800, fontSize: 15, color: config.textColor }}>ğŸ—º ì „ì²´ ì•ˆë‚´ ì§€ë„</span>
              <button onClick={() => setShowMap(false)} style={{ width: 32, height: 32, borderRadius: "50%", border: "none", background: "#f1f5f9", fontSize: 16, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" }}>âœ•</button>
            </div>
            <div style={{ flex: 1, overflow: "auto", padding: 12 }}>
              {config.mapImage ? (
                <img src={config.mapImage} alt="ì•ˆë‚´ ì§€ë„" style={{ width: "100%", borderRadius: 12, display: "block" }} />
              ) : (
                <div style={{ padding: "60px 20px", textAlign: "center", color: "#94a3b8" }}>
                  <div style={{ fontSize: 48, marginBottom: 12 }}>ğŸ—º</div>
                  <p style={{ fontSize: 14 }}>ì•ˆë‚´ ì§€ë„ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
                  <p style={{ fontSize: 12, marginTop: 4 }}>ê´€ë¦¬ìê°€ ì§€ë„ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
              )}
              <div style={{ marginTop: 12 }}>
                {config.locations.map((loc, i) => (
                  <div key={loc.id} style={{ display: "flex", gap: 10, alignItems: "center", padding: "10px 6px", borderBottom: "1px solid #f8fafc" }}>
                    <div style={{ width: 28, height: 28, borderRadius: "50%", background: stamps[loc.id] ? config.accentColor : "#e2e8f0", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, color: stamps[loc.id] ? "#fff" : "#64748b", fontWeight: 700, flexShrink: 0 }}>{stamps[loc.id] ? "âœ“" : i + 1}</div>
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 600, color: config.textColor }}>{loc.icon} {loc.name}</div>
                      <div style={{ fontSize: 11, color: "#94a3b8" }}>{loc.desc}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€â”€ AI CHAT SCREEN â”€â”€â”€ */}
      {screen === "chat" && (
        <div style={{ position: "fixed", inset: 0, background: config.bgColor, zIndex: 900, display: "flex", flexDirection: "column" }}>
          <div style={{ background: `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})`, color: "#fff", padding: "14px 18px", display: "flex", alignItems: "center", gap: 12, flexShrink: 0 }}>
            <button onClick={() => setScreen("tour")} style={{ background: "rgba(255,255,255,0.15)", border: "none", color: "#fff", width: 36, height: 36, borderRadius: "50%", cursor: "pointer", fontSize: 18, display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 }}>â†</button>
            <div style={{ width: 36, height: 36, borderRadius: "50%", overflow: "hidden", flexShrink: 0 }}><AiAvatar size={36} /></div>
            <div style={{ flex: 1 }}><div style={{ fontWeight: 700, fontSize: 14 }}>AI ì•ˆë‚´ ë§¤ë‹ˆì €</div><div style={{ fontSize: 10, opacity: 0.8 }}>ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!</div></div>
          </div>
          <div style={{ flex: 1, overflow: "auto", padding: 14, display: "flex", flexDirection: "column", gap: 10 }}>
            {chatMessages.length === 0 && (
              <div style={{ textAlign: "center", padding: "32px 16px", color: "#94a3b8" }}>
                <AiAvatarLarge />
                <p style={{ fontSize: 14, fontWeight: 600, color: "#475569" }}>AI ì•ˆë‚´ ë§¤ë‹ˆì €ì…ë‹ˆë‹¤</p>
                <p style={{ fontSize: 12, marginBottom: 16 }}>ì¶•ì œì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”!</p>
                {(config.faqList && config.faqList.length > 0 ? config.faqList.slice(0, 4).map(f => {
                  const kw = f.keywords.split(",")[0].trim();
                  return kw + (kw.endsWith("ìš”") || kw.endsWith("ë‹¤") ? "" : " ì•Œë ¤ì£¼ì„¸ìš”");
                }) : ["ì¶•ì œ ì¼ì •ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", "ìŠ¤íƒ¬í”„ íˆ¬ì–´ëŠ” ì–´ë–»ê²Œ ì°¸ì—¬í•˜ë‚˜ìš”?", "ì£¼ì°¨ì¥ì´ ì–´ë””ì— ìˆë‚˜ìš”?"]).map(q => (
                  <button key={q} onClick={() => setChatInput(q)} style={{ display: "block", width: "100%", padding: "10px 14px", marginBottom: 8, borderRadius: 12, border: `1px solid ${config.primaryColor}22`, background: `${config.primaryColor}06`, color: config.primaryColor, fontSize: 13, cursor: "pointer", textAlign: "left" }}>ğŸ’¬ {q}</button>
                ))}
              </div>
            )}
            {chatMessages.map((msg, i) => (
              <div key={i} style={{ display: "flex", justifyContent: msg.role === "user" ? "flex-end" : "flex-start", gap: 8 }}>
                {msg.role !== "user" && <AiAvatar size={30} />}
                <div style={{ maxWidth: "78%", padding: "10px 14px", borderRadius: msg.role === "user" ? "14px 14px 4px 14px" : "14px 14px 14px 4px", background: msg.role === "user" ? config.primaryColor : "#fff", color: msg.role === "user" ? "#fff" : config.textColor, fontSize: 14, lineHeight: 1.7, boxShadow: "0 1px 3px rgba(0,0,0,0.06)", whiteSpace: "pre-wrap" }}>{msg.text}</div>
              </div>
            ))}
            {chatLoading && <div style={{ display: "flex", gap: 8, alignItems: "center" }}><AiAvatar size={30} /><div style={{ padding: "10px 16px", background: "#fff", borderRadius: 14, boxShadow: "0 1px 3px rgba(0,0,0,0.06)" }}><span style={{ fontSize: 18 }} className="dotpulse">â€¢â€¢â€¢</span></div></div>}
            <div ref={chatEndRef} />
          </div>
          <div style={{ padding: "10px 14px", borderTop: "1px solid #e2e8f0", background: "#fff", display: "flex", gap: 8, flexShrink: 0, paddingBottom: "max(10px, env(safe-area-inset-bottom))" }}>
            <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendChat(); } }} placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style={{ flex: 1, padding: "12px 16px", borderRadius: 24, border: "2px solid #e2e8f0", fontSize: 14, outline: "none" }} />
            <button onClick={sendChat} disabled={!chatInput.trim() || chatLoading} style={{ width: 44, height: 44, borderRadius: "50%", border: "none", background: chatInput.trim() ? config.primaryColor : "#e2e8f0", color: "#fff", fontSize: 18, cursor: chatInput.trim() ? "pointer" : "default" }}>â†‘</button>
          </div>
        </div>
      )}

      {/* â”€â”€â”€ HEADER â”€â”€â”€ */}
      <div style={{ background: `linear-gradient(160deg, ${config.primaryColor} 0%, ${config.secondaryColor} 100%)`, padding: "22px 20px 52px", textAlign: "center", position: "relative", overflow: "hidden" }}>
        <BgAnimation theme={config.bgTheme} />
        {config.heroImage && <img src={config.heroImage} alt="" style={{ width: 50, height: 50, objectFit: "contain", position: "absolute", top: 12, left: 16, filter: "drop-shadow(0 2px 6px rgba(0,0,0,0.2))", zIndex: 2 }} />}
        <h1 style={{ fontFamily: config.titleFont, fontSize: 22, color: "#fff", margin: 0, textShadow: "0 2px 8px rgba(0,0,0,0.2)", position: "relative", zIndex: 2 }}>{config.festivalName}</h1>
        <p style={{ color: "rgba(255,255,255,0.8)", fontSize: 12, marginTop: 3, letterSpacing: 2, position: "relative", zIndex: 2 }}>{config.subtitle}</p>
        <p style={{ color: "rgba(255,255,255,0.9)", fontSize: 13, marginTop: 8, position: "relative", zIndex: 2 }}>ğŸ‘‹ <strong>{user?.name}</strong>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</p>
      </div>

      {/* â”€â”€â”€ PROGRESS CARD â”€â”€â”€ */}
      <div style={{ margin: "-32px 16px 14px", background: config.cardBg, borderRadius: 18, padding: "18px 18px 14px", boxShadow: "0 6px 24px rgba(0,0,0,0.08)", position: "relative", zIndex: 10 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
          <span style={{ fontSize: 14, fontWeight: 700, color: config.textColor }}>ğŸ—‚ ìŠ¤íƒ¬í”„ ìˆ˜ì§‘</span>
          <span style={{ fontSize: 22, fontWeight: 900, color: config.primaryColor, fontFamily: config.titleFont }}>{stampCount} / {config.locations.length}</span>
        </div>
        <div style={{ display: "flex", justifyContent: "center", gap: 8, flexWrap: "wrap" }}>
          {config.locations.map(loc => <StampIcon key={loc.id} loc={loc} stamped={!!stamps[loc.id]} size={42} />)}
        </div>
        <div style={{ marginTop: 12, height: 7, background: "#e8edf2", borderRadius: 4, overflow: "hidden" }}>
          <div style={{ height: "100%", width: `${(stampCount / Math.max(config.locations.length, 1)) * 100}%`, background: `linear-gradient(90deg, ${config.primaryColor}, ${config.accentColor})`, borderRadius: 4, transition: "width 0.6s cubic-bezier(0.34,1.56,0.64,1)" }} />
        </div>
        {allStamped && <button onClick={() => setShowComplete(true)} style={{ width: "100%", marginTop: 12, padding: 13, borderRadius: 12, border: "none", background: `linear-gradient(135deg, ${config.accentColor}, #f59e0b)`, color: "#fff", fontSize: 15, fontWeight: 800, cursor: "pointer", animation: "pulse 2s infinite", fontFamily: config.titleFont }}>ğŸ† ê¸°ë…í’ˆ ìˆ˜ë ¹í•˜ê¸°</button>}
      </div>

      {/* â”€â”€â”€ SCAN & MAP BUTTONS â”€â”€â”€ */}
      <div style={{ padding: "0 16px", display: "flex", gap: 10, marginBottom: 14 }}>
        <button onClick={() => { setScanResult(null); startScanner(); }} style={{ flex: 2, padding: 14, borderRadius: 14, border: "none", background: `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})`, color: "#fff", fontSize: 15, fontWeight: 800, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", gap: 8, boxShadow: `0 4px 16px ${config.primaryColor}33` }}>
          <span style={{ fontSize: 20 }}>ğŸ“·</span> QR ìŠ¤ìº”
        </button>
        <button onClick={() => setShowMap(true)} style={{ flex: 1, padding: 14, borderRadius: 14, border: `2px solid ${config.primaryColor}22`, background: config.cardBg, color: config.primaryColor, fontSize: 14, fontWeight: 700, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>
          ğŸ—º ì§€ë„
        </button>
      </div>

      {/* â”€â”€â”€ LOCATIONS LIST â”€â”€â”€ */}
      <div style={{ padding: "0 16px" }}>
        <h3 style={{ fontSize: 14, fontWeight: 800, color: config.textColor, marginBottom: 10 }}>ğŸ“ ìŠ¤íƒ¬í”„ ì¥ì†Œ</h3>
        {config.locations.map((loc) => (
          <div key={loc.id} style={{ background: config.cardBg, borderRadius: 14, padding: "14px 14px", marginBottom: 8, boxShadow: "0 2px 8px rgba(0,0,0,0.04)", display: "flex", gap: 12, alignItems: "center", border: stamps[loc.id] ? `2px solid ${config.accentColor}30` : "1px solid #f1f5f9", transition: "all 0.3s" }}>
            <StampIcon loc={loc} stamped={!!stamps[loc.id]} size={44} />
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ fontSize: 14, fontWeight: 700, color: config.textColor }}>{loc.name}</div>
              <div style={{ fontSize: 11, color: "#94a3b8", marginTop: 2 }}>{loc.desc}</div>
              <div style={{ fontSize: 11, color: config.primaryColor, marginTop: 3, fontWeight: 500 }}>ğŸ“Œ {loc.mission}</div>
            </div>
            {stamps[loc.id] && <div style={{ background: `${config.accentColor}15`, color: config.accentColor, padding: "4px 10px", borderRadius: 20, fontSize: 10, fontWeight: 800, whiteSpace: "nowrap" }}>ì™„ë£Œ âœ“</div>}
          </div>
        ))}
      </div>

      {/* â”€â”€â”€ BOTTOM NAV â”€â”€â”€ */}
      <div style={{ position: "fixed", bottom: 0, left: 0, right: 0, background: "#fff", borderTop: "1px solid #e8edf2", display: "flex", justifyContent: "space-around", alignItems: "flex-end", padding: "6px 0", paddingBottom: "max(6px, env(safe-area-inset-bottom))", zIndex: 100 }}>
        {config.linkHome?.url && (
          <a href={config.linkHome.url} target="_blank" rel="noopener noreferrer" style={{ border: "none", background: "transparent", display: "flex", flexDirection: "column", alignItems: "center", gap: 2, cursor: "pointer", color: "#94a3b8", fontSize: 10, fontWeight: 600, padding: "4px 10px", textDecoration: "none" }}>
            <span style={{ fontSize: 19 }}>{config.linkHome.icon || "ğŸŒ"}</span>{config.linkHome.label || "í™ˆí˜ì´ì§€"}
          </a>
        )}
        <button onClick={() => setScreen("tour")} style={{ border: "none", background: "transparent", display: "flex", flexDirection: "column", alignItems: "center", gap: 2, cursor: "pointer", color: screen === "tour" ? config.primaryColor : "#94a3b8", fontSize: 10, fontWeight: 600, padding: "4px 10px" }}>
          <span style={{ fontSize: 19 }}>ğŸ—º</span>íˆ¬ì–´
        </button>
        <button onClick={() => { setScanResult(null); startScanner(); }} style={{ border: "none", background: `linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor})`, width: 54, height: 54, borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", marginTop: -22, boxShadow: `0 4px 20px ${config.primaryColor}44`, position: "relative" }}>
          <span style={{ fontSize: 24 }}>ğŸ“·</span>
        </button>
        <button onClick={() => setScreen("chat")} style={{ border: "none", background: "transparent", display: "flex", flexDirection: "column", alignItems: "center", gap: 2, cursor: "pointer", color: "#94a3b8", fontSize: 10, fontWeight: 600, padding: "4px 10px" }}>
          {config.aiCharImage ? <img src={config.aiCharImage} alt="" style={{ width: 21, height: 21, borderRadius: "50%", objectFit: "cover" }} /> : <span style={{ fontSize: 19 }}>ğŸ¤–</span>}AIì•ˆë‚´
        </button>
        {config.linkSns?.url && (
          <a href={config.linkSns.url} target="_blank" rel="noopener noreferrer" style={{ border: "none", background: "transparent", display: "flex", flexDirection: "column", alignItems: "center", gap: 2, cursor: "pointer", color: "#94a3b8", fontSize: 10, fontWeight: 600, padding: "4px 10px", textDecoration: "none" }}>
            <span style={{ fontSize: 19 }}>{config.linkSns.icon || "ğŸ“¸"}</span>{config.linkSns.label || "SNS"}
          </a>
        )}
      </div>

      <style>{`
        @keyframes bounceIn { 0% { transform:scale(0.3);opacity:0 } 50% { transform:scale(1.05) } 70% { transform:scale(0.95) } 100% { transform:scale(1);opacity:1 } }
        @keyframes pulse { 0%,100% { transform:scale(1) } 50% { transform:scale(1.02) } }
        @keyframes slideUp { from { transform:translateY(40px);opacity:0 } to { transform:translateY(0);opacity:1 } }
        @keyframes scanLine { 0% { top:10% } 50% { top:85% } 100% { top:10% } }
        @keyframes toastIn { from { transform: translateX(-50%) translateY(-20px); opacity:0; } to { transform: translateX(-50%) translateY(0); opacity:1; } }
        @keyframes twinkle { 0%,100% { opacity: 0.15; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.4); } }
        @keyframes shootStar { 0% { left: -20%; opacity: 0; } 5% { opacity: 1; } 30% { left: 120%; opacity: 0; } 100% { left: 120%; opacity: 0; } }
        @keyframes nebulaPulse { 0%,100% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }
        @keyframes orbitSpin { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(360deg); } }
        @keyframes electronFloat { 0%,100% { transform: translateY(0) translateX(0); } 25% { transform: translateY(-15px) translateX(10px); } 50% { transform: translateY(-5px) translateX(-8px); } 75% { transform: translateY(-20px) translateX(5px); } }
        @keyframes helixWave { 0%,100% { transform: translateY(0); opacity: 0.25; } 50% { transform: translateY(-8px); opacity: 0.5; } }
        @keyframes circuitPulse { 0%,100% { opacity: 0.15; box-shadow: 0 0 4px rgba(0,255,200,0.1); } 50% { opacity: 0.6; box-shadow: 0 0 12px rgba(0,255,200,0.4); } }
        @keyframes dataFlowV { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 0.7; } 90% { opacity: 0.7; } 100% { transform: translateY(60vh); opacity: 0; } }
        @keyframes dataFlowH { 0% { transform: translateX(0); opacity: 0; } 10% { opacity: 0.7; } 90% { opacity: 0.7; } 100% { transform: translateX(50vw); opacity: 0; } }
        @keyframes rocketStar { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-120vh); opacity: 0; } }
        @keyframes bubbleUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 10% { opacity: 1; } 80% { opacity: 0.6; } 100% { transform: translateY(-110vh) scale(1.2); opacity: 0; } }
        @keyframes floatDown { 0% { transform: translateY(-10vh) rotate(0deg); opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateY(110vh) rotate(360deg); opacity:0; } }
        * { -webkit-tap-highlight-color:transparent; box-sizing:border-box; }
        input,textarea,select { font-family:inherit; }
        .dotpulse { animation:blink 1.4s infinite; }
        @keyframes blink { 0%,100% { opacity:0.2 } 50% { opacity:1 } }
      `}</style>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));
</script>
</body>
</html>
